---
title: STM8S 时钟控制
date: 2019-03-03 12:57:13
tags:
    - 硬件拾忆
    - STM8
---

---

------

### 一、时钟控制  



时钟控制器功能强大而且灵活易用。其目的在于使用户获得最好性能的同时，亦能保证消耗的功率最低。



用户可独立管理各个时钟源，并将它们分配到 CPU 各个外设。主时钟和 CPU 时钟均带有预分频器。

<!--more-->

具有安全可靠的无故障时钟切换机制，可在程序运行中将主时钟从一个时钟源切换到另一个时钟源。



---

### 二、抗电磁干扰时钟配置寄存器



为了避免由电磁干扰造成的对应用程序误写操作或系统挂起，大多数关键的时钟寄存器都有一个互补寄存器与之相对应。系统将会自动检测这些关键寄存器与其互补寄存器之间是否匹配。如果不匹配，则产生一个 EMS 复位，从而使应用程序恢复到正常操作。



---

### 三、时钟树

![Image.png](https://i.loli.net/2019/03/03/5c7b663ce673f.png)



---

### 四、主时钟源



下面 4 种时钟源可用作主时钟：

- 1~24MHz 高速外部晶体振荡器（HSE）

- 最大 24MHz 高速外部时钟信号（HSE user-ext）

- 16MHz 高速内部 RC 振荡器（HSI）

- 128KHz 低速内部 RC（LSI）



各个时钟源可单独打开或关闭，从而优化功耗。



#### 1、HSE



高速外部时钟信号可由以下两个时钟源产生：

- HSE外部晶体/陶瓷谐振器

- HSE用户外部有源时钟



![Image.png](https://i.loli.net/2019/03/03/5c7b66e1d3756.png)



为了最大限度减小输出失真和减小启动的稳定时间，谐振器和负载电容应尽可能得靠近振荡器引脚。负载电容值应根据所选的振荡器进行调整。



外部晶体振荡器在启动时的输出时钟信号是不稳定的，默认情况下，在时钟信号被使用之前会插入 2048 个振荡周期的延迟。用户可通过设置选项字节 HSECNT 来缩短稳定时间。



外部时钟寄存器 CLK_CEKR 中的标志位 HSERDY 用以指示高速外部振荡器是否稳定。启动时， HSE 时钟信号将不会生效直至次标志位被硬件置位。



HSE 晶体可通过设置外部时钟寄存器 CLK_ECKR 中的 HSEEN 位来打开或关闭。



用户可通过编程选项位 EXTCLK 选择 HSE 用户外部时钟模式，此时，占空比约 50% 的外部时钟信号（方波，正弦波，三角波）用以驱动 OSCIN 引脚，而 OSCOUT 引脚可作为 GPIO 使用。



#### 2、HSI



HSI 信号由内部 16MHz RC 振荡器与一个可编程分频器（分频因子从 1 到 8）产生。分频因子由寄存器 CLK_CKDIVR 决定。



启动时，主时钟源默认为 HSI RC 时钟的 8 分频，即 fHSI/8。



HSI RC 可提供一个低成本的 16MHz 时钟源，占空比 50%。HSI 启动速度比 HSE 晶体振荡器快，但是精度即使校准也仍然比外部晶体振荡器或陶瓷谐振器低。



内部时钟寄存器 CLK_ICKR 中的标志位 HSIRDY 用以指示 HSI RC 是否稳定。启动时，HSI 时钟信号将不会生效直至此标志位被硬件置位。



HSI RC 可通过设置内部时钟寄存器 CLK_ICKR 中的 HSIEN 位打开或关闭。



**备份时钟源**



当 HSE 晶体振荡器失效时 HSI/8 可作为备份时钟源使用。



**快速启动特性**



如果寄存器 CLK_ICKR 中的 FHWU 位被置 1，则MCU从停机（Halt）模式或活跃停机（Active Halt）模式唤醒时，HSI 将自动被设为主时钟源。 



**校准**



每个产品在出厂时均已经 ST 校准。



复位后，出厂校准值将被自动加载至内部校准寄存器。



如果实际应用中电压或温度偏差较大，将会影响 RC 振荡器的速度。用户可使用 HSI 时钟校准寄存器修正 HSI 的时钟频率。



#### 3、LSI



128KHz 的 LSI RC 时钟是一个低功耗低成本的可选主时钟源，也可在停机（Halt）模式下作为维持独立看门狗和自动唤醒单元（AWU）运行的低功耗时钟源。



LSI 可通过设置内部时钟寄存器 CLK_ICKR 中的 LSIEN 位打开或关闭。



内部时钟寄存器 CLK_ICKR 中的标志位 LSIRDY 用以指示 LSI 是否稳定。启动时，LSI 时钟信号将不会生效直至此标志位被硬件置位。



LSI 出厂也已经校准，但用户不能再进一步校准。



注意：当独立看门狗使用 LSI 为时钟源时，为了保证 CPU 在系统出错时不与独立看门狗使用同一个时钟，当选项字节位 LSI_EN 为 0 时，LSI 不能作为主时钟。



---

### 五、主时钟切换



时钟切换功能为用户提供了一中易用、快速、安全的从一个时钟源切换到另一个时钟源的途径。



#### 1、系统启动



为使系统快速启动，复位后时钟控制器自动使用 HSI 的 8 分频作为主时钟。其原因为 HSI 的稳定时间短，而 8 分频可保证系统在较差的 VDD 条件下安全启动。



一旦主时钟源稳定，用户程序可将主时钟切换到另外的时钟源。



#### 2、主时钟切换的过程



##### 1）自动切换



自动切换使用户可使用最少的指令完成时钟源的切换。应用软件可继续其它操作而不用考虑切换事件所占的确切时间。



- 设置切换控制寄存器（CLK_SWCR）中的位 SWEN，使能切换机制。

- 向主时钟切换寄存器（CLK_SWR）写入一个 8 位的值，用以选择目标时钟源。寄存器 CLK_SWCR 的 SWBSY 被硬件置位，目标源振荡器启动。原时钟源依然被用于驱动内核和外设。



一旦目标时钟源稳定，寄存器 CLK_SWR 中的值将被复制到主时钟状态寄存器（CLK_CMSR）中去。



此时，SWBSY 位被清除，新时钟源替代旧时钟源。寄存器 CLK_SWCR 中的标志位 SWIF 被置位，如果 SWIEN 为 1，则会产生一个中断。



![Image.png](https://i.loli.net/2019/03/03/5c7b6a715920c.png)



##### 2）手动切换



与自动切换不同，不能立即切换，但它允许用户精确地控制切换事件发生的时间。



- 向主时钟切换寄存器（CLK_SWR）写入一个 8 位的值，用以选择目标时钟源。寄存器 CLK_SWCR 的 SWBSY 被硬件置位，目标源振荡器启动。原时钟源依然被用于驱动内核和外设。

- 用户软件需等待至目标时钟源稳定。寄存器 CLK_SWCR 中的标志位 SWIF 用以指示目标时钟源是否已稳定，如果 SWIEN 为 1，则会产生一个中断。

- 最后，由用户软件在所选的时间点，设置寄存器 CLK_SWCR 中的位 SWEN，执行切换。



![Image.png](https://i.loli.net/2019/03/03/5c7b6ad97c5d4.png)



无论是手动切换还是自动切换，如果源时钟源仍然在被其他模块使用（如 LSI 在被独立看门狗使用），则原时钟源将不会被自动关闭。配置内部时钟寄存器 CLK_ICKR 和外部时钟寄存器 CLK_ECKR 中的相应位，可关闭原时钟源。



如果由于某种原因时钟切换没有成功，软件可通过清除标志位 SWBSY 以复位当前的切换操作，使寄存器 CLK_SWR 恢复原值（原时钟源）。



---

### 六、低速时钟源的选择



可通过选择位 CKAWUSEL 来选择自动唤醒单元（AWU）和独立看门狗所使用的低速时钟源，可以是 LSI 或 HSE 的分频。



HSE 的分频值可通过选项字节位 HSEPRSC[1:0] 编程。目的是是 HSE 分频器输出一个 128KHz 的时钟信号。



---

### 七、CPU 时钟分频器



CPU 时钟 fCPU 由主时钟 fMASTER 分频而来，分频因子由时钟分频寄存器（CLK_CKDIVR）中的位 CPUDIV[2:0] 决定。共 7 个分频因子可供选择（1 至 128 中，2 的幂）。



**fCPU 为 CPU 和窗口看门狗提供时钟**。



---

### 八、外设时钟门控



关闭未使用外设的时钟可降低功耗。外设的时钟门控（PCG）模式使用户可在运行模式下随时打开或关闭 fMASTER 与下列外设的连接：

- ADC

- I2C

- AWU（寄存器时钟，而非计数器时钟）

- SPI

- TIM[4:1]

- UART

- CAN（寄存器时钟，而非 CAN 时钟）



**系统复位后，所有外设时钟均处于开的状态**。用户可通过清除 CLK_PCKENR1 或 CLK_PCKENR2 中的 PCKEN 位来关闭响应的外设时钟。但是在关闭外设的时钟前，用户必须设置响应的位禁用该外设。



为了使能一个外设，用户必须先设置寄存器 CLK_PCKENR 中对应的 PCKEN 位，然后设置外设控制寄存器中的外设使能位。



AWU 计数器是由独立于 fMASTER 的内部或外部时钟（LSI 或 HSE）驱动，因此，即使寄存器的时钟已被关掉，该外设依然可以继续运行。



---

### 九、时钟安全系统（CSS）



时钟安全系统用于监控 HSE 时钟源是否失效。当 fMASTER 使用 HSE 作为时钟源时，如果 HSE 时钟由于谐振器损坏、断开或其它原因失效，时钟控制器将激活安全恢复机制，将 fMASTER 自动切换到辅助时钟源 HSI/8。系统将一直使用辅助时钟源，直至 MCU 被复位。



设置时钟安全系统寄存器 CLK_CSSR 中的 CSSEN 位，可使能时钟安全系统。为安全起见，CSS 一旦使能就不能被关闭，直到下一次复位。



必须满足下面的条件，CSS 方可检测 HSE 石英晶体的失效：

- HSE 晶体开：（外部时钟寄存器 CLK_ECKR 中的位 HSEEN=1）

- HSE 振荡器被置为石英晶体：（选项位 EXTCLK为 1）

- CSS 功能开：（寄存器 CLK_CSSR 中 CSSEN=1）



如果当前的主时钟源位 HSE，当失效被检测到时，CSS 将执行以下操作：

- 寄存器 CLK_CSSR 中的 CSSD 位被置为，如果 CSSIEN 为 1，则同时产生一个中断

- CLK_CMSR，CLK_SWR，及 CLK_CKDIVR 中的 HSIDIV[1:0] 位被置为复位值（CKM[7:0]=SW[7:0]=E1h）。HSI/8 称为主时钟

- 每部时钟寄存器 CLK_ICKR 中的 HSIEN 被置位（HSI开）

- 外部时钟寄存器 CLK_ECKR 中的 HSEEN 被清除（HSE关）

- AXU 位被置位，用以指示辅助时钟源 HSI/8 被强制使用



用户可通过软件清除 CSSD 位，但 AXU位 只能由复位清除。



为了提高时钟频率，用户在清除寄存器 CLK_CSSR 中的 CSSD 位以后，课修改寄存器 CLK_CKDIVR 中的 HSIDIV[1:0] 位。



如果失效发生时 HSE 不是主时钟源，主时钟将不会被切换到辅助时钟源，以上操作也不会发生，仅执行下面的操作：

- 外部时钟寄存器 CLK_ECKR 中的 HSEEN 被清除，HSE 关闭。

- 寄存器 CLK_CSSR 中的位 CCSD 被置位，如果 CSSIEN 位 1，则同时产生一个中断。



如果 HSE 不是当前主时钟源，且主时钟正在被切换至 HSE，则在清除 CSSD 位之前，必须先清除寄存器 CLK_SWCR 的 SWBSY 位。



如果当失效被检测到时，HSE 被 CCOSEL 选择为时钟输出模式，则 HSI（HSIDIV）将替代 HSE，被自动强制选择为输出时钟。



---

### 十、时钟输出功能（CCO）



可配置的时钟输出功能使用户可在外部管脚 CCO 上输出指定的时钟。用户可选择下 6 种时钟信号之一作为 CCO 时钟：

- fHSE

- fHSI

- fHSIDIV

- fLSI

- fMASTER

- fCPU（可选择分频）



注意：在所有可能的分频值下，不能保证信号的占空比全部为 50%。



通过配置时钟输出寄存器 CLK_CCOR 中域 CCOSEL[3:0] 可选择输出的时钟。



用户需位指定的 I/O 引脚选择期望输出的时钟。**此 IO 必须通过配置寄存器 Px_CR1 对应的位为 1 来设为上拉输入或推挽输出模式**。



一旦可配置始终输出寄存器 CLK_CCOR 的 CCOEN=1 就开始输出所选定的时钟信号。



如果 CCOBSY 位 为1，则表明可配置时钟输出系统正在工作。只要 CCOBSY 为 1，CCOSEL 位就会被写保护。



如果需要，CCO 可自动激活目标振荡器。当所选时钟就绪时，CCORDY 被置位。



用户可通过清除 CCOEN 位来禁用时钟输出功能。CCOBSY 位和 CCORDY 位都将保持为 1 直到禁用操作结束。从清除 CCOEN 位到这两个标志位被复位之间的时间可能会很长，例如当所选的输出时钟相对于 fCPU 频率很低时。



---

------

### 十一、时钟中断



​     当下列事件发生时，时钟控制器可产生中断：

- 主时钟源切换事件

- CSS 事件



​     这两个中断均可被独立屏蔽



![Image.png](https://i.loli.net/2019/03/03/5c7b6b9f5868f.png)



---

### 十二、时钟寄存器



内部时钟寄存器              CLK_ICKR

外部时钟寄存器              CLK_ECKR

主时钟状态寄存器           CLK_CMSR

主时钟切换寄存器           CLK_SWR

切换控制寄存器              CLK_SWCR

时钟分频寄存器              CLK_CKDIVR

外设时钟门控寄存器1      CLK_PCKENR1

外设时钟门控寄存器2      CLK_PCKENR2

时钟安全系统寄存器        CLK_CSSR

可配置时钟输出寄存器     CLK_CCOR

CAN外部时钟控制寄存器 CLK_CANCCR

HSI时钟修正寄存器         CLK_HSITRIMR

SWIM时钟控制寄存器     CLK_SWIMCCR