---
title: STM8S TIM1 时基单元
tags:
  - 硬件拾忆
  - STM8
abbrlink: 134333cf
date: 2019-03-04 08:57:28
---

---

### 一、简介



TIM1 由一个 16 位自动装载计数器组成，它由一个可编程的预分频器驱动。

<!--more-->

高级控制定时器适用于许多不同的用途：

- 基本的定时

- 测量输入信号的脉冲宽度（输入捕获）

- 产生输出波形（输出比较，PWM 和单脉冲模式）

- 对应不同事件（捕获，比较，溢出，刹车，触发）的中断

- 与 TIM5/TIM6 或者外部信号（外部时钟，复位信号，触发和使能信号）同步



高级控制定时器广泛适用各种控制应用，包括那些需要中间对齐模式 PWM 的应用，该模式支持互补输出和死区时间控制。



高级控制定时器的时钟可以是内部信号，也可以是外部信号，通过寄存器配置来选择。



---

### 二、主要特性



TIM1的特性包括：

- 16 位向上、向下、向上/下自动装载计数器

- 允许在指定数目的计数器周期之后更新定时器寄存器的重复计数器

- 16 位可编程（可实时修改）预分频器，计数器时钟频率的分频系数为 1~65536 间的任意数值

- 同步电路，用于使用外部信号控制定时器以及定时器互联

- 多达四个独立通道可以配置成：
  - 输入捕获
  - 输出比较
  - PWM 生成（边缘或中间对齐模式）
  - 六步 PWM 输出
  - 单脉冲模式输出
  - 三个支持带互补输出，并且死区时间可编程的通道

- 刹车输入信号可以将定时器输出信号置于复位状态或一个已知状态

- 产生中断的事件包括：
  - 更新：计数器向上/向下溢出，计数器初始化（通过软件或内部/外部触发）
  - 触发事件（计数器启动、停止、初始化或由内部/外部触发计数）
  - 输入捕获
  - 输出比较
  - 刹车信号输入



![Image.png](https://i.loli.net/2019/03/04/5c7c7c9c8156d.png)



---

### 三、时基单元



时基单元包含：

- 16位向上/向下计数器

- 16位自动重载寄存器

- 重复计数器

- 预分频器



![Image.png](https://i.loli.net/2019/03/04/5c7c7cb4a5bd5.png)



16 位计数器，预分频器，自动重载寄存器和重复计数器都可以通过软件读写。自动重载寄存器由预装载寄存器和影子寄存器组成。



可在两种模式下写自动重载寄存器：

- 自动预装载已使能（TIM1_CR1 寄存器的 ARPE 位置位）。在此模式下，写入自动重载寄存器的数据将被保存在预装载寄存器中，并在下一个更新事件（UEV）时传送到影子寄存器。

- 自动预装载已禁止（TIM1_CR1 寄存器的 ARPE 位清除）。在此模式下，写入自动重载寄存器的数据将立即写入影子寄存器。



更新事件的产生条件：

- 计数器向下或向下溢出

- 软件置位了 TIM1_EGR 寄存器的 UG 位

- 时钟/触发控制器产生了触发事件



在预装载使能时（ARPE=1），如果发生了更新事件，预装载寄存器中的数值（TIM1_ARR）将写入影子寄存器中，并且 TIM1_PSCR 寄存器中的值将写入预分频器中。



置位 TIM1_CR1 寄存器的 UDIS 位将禁止更新事件（UEV）。



计数器由预分频器的输出 CK_CNT 驱动，而 CK_CNT 仅在 IM1_CR1 寄存器的计数器使能位（CEN）被置位时才有效。



在使能了 CEN 位的一个时钟周期后，计数器才开始计数。



#### 1、读写 16 位计数器



写计数器的操作没有缓存，并且可以在任何时候写 TIM1_CNTRH 和 TIM1_CNTRL 寄存器，因此建议不要再计数器运行时写入新的数值，以免写入错误的数值。



读计数器的操作带有 8 位缓存。在用户读了高位（MS）字节后，低位（LS）字节将被自动缓存，缓存的数据在 16 位的读操作完成之前不会有变化。



注意：不要使用 LDW 指令来读取 16 位计数器的值，因为此指令先读低位（LS）字节，这样读出的数值是错误的。



![Image.png](https://i.loli.net/2019/03/04/5c7c7ccdcafc7.png)



#### 2、16 位 TIM1_ARR 寄存器的写操作



通过预装载寄存器向 TIM1_ARR 寄存器中写入 16 位的值。此操作由两条指令完成，每条指令写入 1 个字节，高位（MS）字节是必须先写入的。



影子寄存器在高位（MS）字节写入后被锁定，并保持到低位（LS）字节写完。不要使用 LDW 指令，因为此指令先写低位（LS）字节，这将导致写入的数值错误。



#### 3、预分频器



TMI1 的预分频器基于一个由 16 位寄存器（TIM1_PSCR）控制的 16 位计数器。由于这个控制寄存器带有缓冲器，因此它能够在运行时被改变。预分频器可以将计数器的时钟频率按 1 到 65536 之间的任意值分频。



计数器的频率可以由下式计算：

fCK_CNT = fCK_PSC/（PSCR[15:0] + 1）



预分频值由预装载寄存器写入，保存了当前使用值的影子寄存器在低位（LS）写入后被载入。



需两次单独的写操作来写 16 位寄存器，高位（MS）先写。不要使用先写低位的 LDW 指令。



新的预分频器的值在下一次更新事件到来时被采用。



对 TIM1_PSCR 寄存器的读操作通过预装载寄存器完成，因此不需要特别的关注。



#### 4、向上计数模式



计数器从 0 计数到用户定义的比较值（TIMx_ARR 寄存器的值），然后重新从 0 开始计数并产生一个计数器溢出事件，同时，如果 TIM1_CR1 寄存器的 UDIS 位是 0，将会产生一个更新事件（UEV）。



![Image.png](https://i.loli.net/2019/03/04/5c7c7cecf2195.png)



置位 TIMx_EGR 寄存器的 UG 位（通过软件方式或使用从模式控制器）同样可产生一个更新事件。



使用软件置位 TIMx_CR1 寄存器的 UDIS 位，可以禁止更新事件，这样可避免在更新预装载寄存器时更新影子寄存器。在 UDIS 位被清除之前，将不产生更新事件。但是在应该产生更新事件 时，计数器仍会被清 0，同时预分频器的计数也被清 0（但预分频器的数值不变）。此外，如果设置了 TIMx_CR1 寄存器中的 URS 位（选择更新请求），设置 UG 位将产生一个更新事件 UEV，但硬件不设置 UIF 标志（即不产生中断请求）。这是为了避免在捕获模式下清除计数器时，同时产生更新和捕获中断。



当发生一个更新事件时，所有的寄存器都被更新，硬件同时（依据 URS 位）设置更新标志位（TIMx_SR 寄存器的 UIF 位）：

- 自动装载影子寄存器被重新置入预装载寄存器的值（TIMx_ARR）

- 预分频器的缓存器被置入预装载寄存器的值（TIMx_PSC 寄存器的内容）



![Image.png](https://i.loli.net/2019/03/04/5c7c7d028d058.png)

![Image.png](https://i.loli.net/2019/03/04/5c7c7d11772c7.png)



#### 5、向下计数模式



计数器从自动装载的值（TIMx_ARR 寄存器的值）开始向下计数到 0，然后再从自动装载的值重新开始计数，并产生一个计数器向下溢出时间。如果 TIM1_CR1 寄存器的 UDIS 位被清除，还会产生一个更新事件（UEV）。



![Image.png](https://i.loli.net/2019/03/04/5c7c7d28e89d1.png)



置位 TIMx_EGR 寄存器的 UG 位（通过软件方式或者使用从模式控制器）也同样可以产生一个更新事件。



置位 TIMx_CR1 寄存器的 UDIS 位可以禁止 UEV 事件。这样可以避免在更新预装载寄存器时更新影子寄存器。因此 UDIS 位清除之前不会产生更新事件。然而，计数器仍会从当前自动加载值重新开始计数，并且预分频器的计数器重新从 0 开始（但预分频器不能被修改）。



 此外，如果设置了 TIMx_CR1 寄存器中的 URS 位（选择更新请求），设置 UG 位将产生一个更新事件 UEV 但不设置 UIF 标志（因此不产生中断），这是为了表面在发生补货时间并清除计数器时，同时产生更新和捕获中断。



当发生更新事件时，所有的寄存器都被更新，并且（根据 URS 位的设置）更新标志位（TIMx_SR 寄存器中的 UIF 位）也被设置：



预分频器的缓存器被存入预装载的值（TIMx_PSC 寄存器的值）。



当前的自动加载寄存器被更新为预装载值（TIMx_ARR 寄存器中的内容）。要注意自动装载寄存器在计数器重载入之前被更新，因此下一个周期才是预期的值。



以下是一些当 TIMx_ARR = 0x36 时，计数器在不同时钟频率下的图表。



下图描述了在向下计数模式下，预装载不使能时新的数值在下个周期时被写入。



![Image.png](https://i.loli.net/2019/03/04/5c7c7d487f1d4.png)



#### 6、中央对齐模式（向上/向下计数）



在中央对其模式。计数器从 0 开始计数到自动加载的值（TIMx_ARR寄存器）-1，产生一个溢出事件，然后向下计数到 0 并且产生一个计数器下溢事件，然后再从 0 开始重新计数。



在此模式下，不能写入 TIMx_CR1中 的 DIR 方向位。它由硬件更新并指示当前的计数方向。



![Image.png](https://i.loli.net/2019/03/04/5c7c7d5c4e2f3.png)

如果定时器带有重复计数器（如 TIM1），在重复了指定次数（TIM1_RCR 的值）的向上和向下溢出之后会产生更新事件（UEV）。否则每一次的向上向下溢出都会产生更新事件。



置位 TIMx_EGR 寄存器的 UG 位（通过软件方式或者使用从模式控制器）也同样可以产生一个更新事件。此时，计数器重新从 0 开始计数，预分频器也重新从 0 开始计数。



设置 TIMx_CR1 寄存器中的 UDIS 位可以禁止 UEV 事件。这样可以避免在更新预装载寄存器时更新影子寄存器。因此 UDIS 位被清 0 之前不会产生更新事件。然而，计数器仍会根据当前自动重加载的值，继续向上或向下计数。如果定时器带有重复计数器，由于重复寄存器没有双重的缓冲，新的重复数值将立刻生效，因此在修改时需要小心。



此外，如果设置了 TIMx_CR1 寄存器中的 URS 位（选择更新请求），设置 UG 位将产生一个更新事件 UEV 但不设置 UIF 标志（因此不产生中断），这是为了避免在发生捕获事件并清除计数器时，同时产生更新和捕获中断。



当发生更新事件时，所有的寄存器都被更新，并且（根据 URS 位的设置）更新标志位（TIMx_SR 寄存器中的 UIF 位）也被设置。



预分频器的缓存器被加载为预装载（TIMx_PSC 寄存器）的值。



当前的自动加载寄存器被更新为预装载值（TIMx_ARR 寄存器中的内容）。要注意到如果因为计数器溢出而产生更新，自动重装载寄存器将在计数器重载入之前被更新，因此下一个周期才是预期的值（计数器被装载位新的值）。以下是一些计数器在不同时钟频率下的操作的例子：

![Image.png](https://i.loli.net/2019/03/04/5c7c7d7479a01.png)



使用中央对齐模式的提示：



- 启动中央对齐模式时，计数器将按照原有的向上/向下的配置计数。也就是说 TIM1_CR1 寄存器中的 DIR 位将决定计数器时向上还是向下计数。此外，软件不能同时修改 DIR 和 CMS 位的值。



- 不推荐在中央对齐模式下，计数器正在计数时写计数器的值，这将导致不能预料的后果。具体的说：
  - 向计数器写入了比自动装载值更大的数值时（TIM1_CNT > TIM1_ARR），但计数器的技术方向不发生改变。例如计数器已经向上溢出，但计数器仍然向上计数。
  - 向计数器写入了 0 或者 TIM1_ARR 的值，但更新事件不发生。



- 安全使用中央对齐模式的计数器的方法是在启动计数器之前先用软件（置位 TIM1_EGR 寄存器的 UG 位）产生一个更新事件，并且不在计数器计数时修改计数器的值。



#### 7、重复计数器



时基单元一节解释了计数器向上/向下溢出时更新事件（UEV）是如何产生的，然而事实上它只能在重复计数器的值达到 0 的时候产生。这个特性对产生 PWM 信号非常有用。



这意味着在每 N 次计数上溢或下溢时，数据从预装载寄存器传输到影子寄存器（TIMx_ARR 自动重载入寄存器，TIMx_PSC 预装载寄存器，还有在比较模式下的捕获/比较寄存器 TIMx_CCRx），N 是 TIMx_RCR 重复计数寄存器中的值。



重复计数器在下述任一条件成立时递减：

- 向上计数模式下每次计数器向上溢出时

- 向下计数模式下每次计数器向下溢出时

- 中央对齐模式下每次上溢和下溢时



虽然这样限制了 PW 的最大循环周期为 128，但它能够在每个 PWM 周期 2 次更新占空比。在中央对齐模式下，因为波形是对称的，如果每个 PWM 周期中仅刷新一次比较寄存器，则最大的分辨率为 2*tCK_PSC。



重复计数器是自动加载的，重复速率由 TIMx_RCR 寄存器的值定义。当更新事件由软件产生（通过设置 TIMx_EGR 中的 UG 位）或者通过硬件的从模式控制器产生，则无论重复计数器的值是多少，立即发生更新事件，并且 TIMx_RCR 寄存器中的内容被重载到重复计数器。



![Image.png](https://i.loli.net/2019/03/04/5c7c7d8ca3063.png)

