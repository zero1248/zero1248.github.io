---
title: STM8S Flash 程序存储器和数据 EEPROM
date: 2019-03-03 10:06:18
tags:
    - 硬件拾忆
    - STM8
---

---

### 介绍



stm8 内部的 FLASH 程序存储器和数据 EEPROM 由一组通用寄存器来控制。用户可以使用这些寄存器来编程或擦出存储器的内容，设置写保护，或者配置特定的低功耗模式。用户也可以对器件的选项字节（Option byte）进行编程。

<!--more-->

---

### 术语



块 Block —— 一个块是指可由一个简单编程操作变成或擦除的一组字节。块级的操作非常快，是标准的编程和擦除操作。

页 Page —— 一页由一组块组成。stm8s 器件拥有启动代码，程序代码和数据 EEPROM，这些区域都有特定的结构所保护。通过对特定的选项字节进行操作，这些区域的大小能够以页为单位来进行调整。



---

### Flash 主要特性



##### stm8s EEPROM 分为两个存储器阵列：

- 最多至 128K 字节的 FLASH 程序存储器，不同的器件容量有所不同。

- 最多至 2K 字节的数据 EERPOM（包括option byte），不同器件容量不同。



##### 编程模式：

- 字节编程和自动快速字节编程（没有擦除操作）

- 字编程

- 块编程和快速块编程（没有擦除操作）

- 在编程/擦除操作结束时和发生非法编程操作时产生中断



读同时写（RWW）功能。该特性并非所有 stm8s 器件都有。



在应用编程（IAP）和在线编程（ICP）能力。



##### 保护特性：

- 存储器度保护（ROP）

- 基于存储器存取安全系统（MASS 密钥）的程序存储器写保护

- 基于存储器存取安全系统（MASS 密钥）的数据存储器写保护

- 可编程的用户启动代码区域（UBC）写保护



在待机（Halt）模式和活跃待机（Active-halt）模式下，存储器可配置为运行状态和掉电状态。



---

### 存储器组织结构



#### 1、stm8s 和 stm8af 存储器组织结构

 

stm8s 和 stm8af 的 EEPROM 以 32 位字长（每字 4 字节）为基础组织起来。根据不同的器件，存储器组织结构有所不同：



##### 小容量 stm8s 和 stm8af 器件：



- 8K Flash 程序存储器，每页（或块）64 字节，共 128 页（或块）。分为 2 个区域，大小可由选项字节配置的 user boot code 区（UBC），和主程序存储区。FLash 程序存储器地址映射在 stm8s 地址空间的最上端，且包括复位和中断向量。



- 最多 640 字节数据 EEPROM，每页（或块） 64 字节，共 10 页（或块） 。有一个块（64 字节）中包含 11 个用来配置器件硬件特性的选项字节。选项字节可在 user，IAP 和 ICP/SWIM 模式下编程。



##### 中容量 stm8s 和 stm8af 器件：



- 从 16K 到 32K Flash 程序存储器，每页 4 个 128 字节的块，最多 64 页。Flash 程序存储器分为 2 个区， 大小可由选项字节配置的 user boot code 区（UBC），和主程序存储区。FLash 程序存储器地址映射在 stm8s（或 stm8af）地址空间的最上端，且包括复位和中断向量。



- 最多1K 字节数据 EEPROM，每页 4 个 128 字节的块，最多 2 页。有一个块（128字节）中包含 13 个用来配置器件硬件特性的选项字节。选项字节可在 user，IAP 和 ICP/SWIM 模式下编程。



##### 大容量 stm8s 和 stm8af 器件：



- 从 32 到 128K 字节 Flash 程序存储器，每页 4 个 128 字节的块，最多 256 页。Flash 程序存储器分为 2 个区， 大小可由选项字节配置的 user boot code 区（UBC），和主程序存储区。FLash 程序存储器地址映射在 stm8s（或 stm8af）地址空间的最上端，且包括复位和中断向量。



- 最多 2K 字节数据 EEPROM，每页 4 个 128 字节的块，最多 4 页。有一个块（128 字节）中包含 15 个用来配置器件硬件特性的选项字节。选项字节可在 user，IAP 和 ICP/SWIM 模式下编程。



EEPROM 存取时间决定了器件最多运行在 16MHz 下。对于时钟频率超过 16MHz 的应用，FLash/数据 EEPROM 存取必须被被配置成等待状态（1 wait state）。这由器件选项字节使能。

![Image.png](https://i.loli.net/2019/03/03/5c7b3b8457334.png)



![Image.png](https://i.loli.net/2019/03/03/5c7b3b9826fa5.png)



![Image.png](https://i.loli.net/2019/03/03/5c7b3bab0582e.png)

#### 2、存储器存取/等待状态配置



Flash/数据EEPROM 存取时间允许器件运行在最高 16MHz 时钟下，无需等待状态。



当使用高速外部时钟（HSE）在更高的最多 24MHz 下时，需要一个等待状态。在这种情况下，器件应该对选项字节进行编程以插入这个等待状态。



#### 3、用户启动区域（UBC）



UBC 包含有复位和中断向量表，它可用于存储 IAP 及通信程序。UBC 有一个两级保护结构可保护用户代码及数据在 IAP 编程中免于无意的擦除或修改。这意味着该区域总是写保护的，而且写保护不能通过使用 MASS 密钥来解锁。



在 ICP 模式下（使用 SWIM 接口）可以通过修改选项字节来配置 UBC 的大小。UBC 选项字节指定了分配在 UBC 中的页的数量。UBC 区域的歧视地址是 0x8000。



可以通过读取 UBC 选项字节来获得 UBC 区域的大小。



![Image.png](https://i.loli.net/2019/03/03/5c7b3c4aa8835.png)



![Image.png](https://i.loli.net/2019/03/03/5c7b3c5b3ce50.png)

前两页的 128 个字节包含了 32 个中断向量。



![Image.png](https://i.loli.net/2019/03/03/5c7b3c9e0b417.png)

#### 4、数据 EEPROM（DATA）



数据 EEPROM（DATA）区域可用于存储用户具体项目所需的数据。默认情况下，DATA 区域是写保护的，这样可以在主程序工作在 IAP 模式时防止 DATA 区域被无意地修改。只有使用特定的 MASS 密钥才能对 DATA 区域的写保护解锁。



#### 5、主程序区域



主程序区是 Flash 程序存储器中用于存储应用代码的区域。



#### 6、选项字节（Option bytes）



选项字节用于配置硬件特性和存储器保护状态，这些字节位于同一页的特定存储器阵列中。



选项字节可以再 ICP/SWIM 模式中或 IAP 模式中修改，注意此时要保证 FLASH_CR2 中的 OPT 位为 1 以及 FLASH_NCR2 中的 NOPT 位为 0。



对选项字节的编程参考 STM8 SWIM 通讯协议和调试模块用户手册 UM0470。



---

### 存储器保护



#### 1、读保护



当选项字节中的 ROP 字节被编程为 0xAA 时，读保护就生效了。这种情况下，无论写保护是否生效，在 ICP 模式中（使用 SWIM 接口）读取或修改 FLASH 程序存储器和 DATA 区域都是被禁止的。即使认为没有什么保护是完全不可破解的，对于一个通用微处理器来说，stm8 的读保护的特性也提供了一个非常高水平的保护级别。



##### 取消写保护



可以在 ICP 模式中通过对选项字节中的 ROP 字节重新编程来接触程序存储器、UBC 和 DATA 区域的读保护。在这种情况下，程序存储器、UBC、DATA 区域以及选项字节都被自动擦除，器件也可以被重新编程了。



#### 2、存储器存取安全系统（MASS）



在复位以后，主程序和 DATA 区域都被自动保护以防止无意的写操作。在试图修改其内容前必须对其解锁，而解锁的机制由存储器存取安全系统（MASS）来管理。



UBC 区域的特性指明了在 UBC 中的内容一直是写保护的。一旦存储器内容被修改完毕，推荐将写保护使能以防止数据被破坏。



##### 对主程序存储器的写保护



在器件复位后，可以通过向 FLASH_PUKR 寄存器连续写入两个被叫作 MASS 密钥的值来解除主程序存储器的写保护。这两个写入 FLASH_PUKR 的值回合一下两个硬件密钥值相比较：

- 第一个硬件密钥：8'b01010110（0x56）

- 第二个硬件密钥：8'b10101110（0xAE）



需要通过如下步骤来解除主程序存储器区域的写保护：



1）向 FLASH_PUKR 写入第一个 8 位密钥。在系统复位后，当这个寄存器被首次写入值时，数据总线上的值没有被直接锁存到这个寄存器中，而是和第一个硬件密钥值（0x56）相比较。



2）如果密钥输入错误，FLASH_PUKR 寄存器在下一次系统复位之前将一直被锁住。在下一次复位前，再向该寄存器进行的任何写操作都会被系统忽略掉。



3）如果第一个硬件密钥正确，当这个寄存器被第二次写入值时，数据总线上的值没有被直接锁存到这个寄存器中，而是和第二个硬件密钥值（0xAE）相比较。



4）如果密钥输入错误，FLASH_PUKR 寄存器在下一次系统复位之前将一直被锁住。在下一次复位前，再向该寄存器进行的任何写操作都会被系统忽略掉。



5）如果第二个硬件密钥正确，主程序存储器写保护被解除，同时 FLASH_IAPSR 中的 PUL 位为 1。



在开始编程之前，应用程序可以校验 PUL 为是否被有效置 1。应用程序可以再任意时刻通过清 PUL 位来重新禁止对 DATA 区域的写操作。



##### 对DATA区域的写操作



在器件复位后，可以通过向FLASH_DUKR寄存器连续写入两个被叫作MASS密钥的值来解除主程序存储器的写保护。这两个写入FLASH_PUKR的值回合一下两个硬件密钥值相比较：

- 第一个硬件密钥：8'b01010110（0x56）

- 第二个硬件密钥：8'b10101110（0xAE）



需要通过如下步骤来解除数据区域的写保护：



1）向FLASH_DUKR 写入第一个 8 位密钥。在系统复位后，当这个寄存器被首次写入值时，数据总线上的值没有被直接锁存到这个寄存器中，而是和第一个硬件密钥值（0x56）相比较。



2）如果密钥输入错误，应用程序可以尝试重新输入这两个 MASS 密钥来对 DATA 区域进行解锁。



3）如果第一个硬件密钥正确，当这个寄存器被第二次写入值时，数据总线上的值没有被直接锁存到这个寄存器中，而是和第二个硬件密钥值（0xAE）相比较。



4）如果密钥输入错误，DATA EEPROM 区域在下一次系统复位之前将一直保持写保护状态。在下一次复位前，再向该寄存器进行的任何写操作都会被系统忽略掉。



5）如果第二个硬件密钥正确，DATA 区域的写保护被解除，同时 FLASH_IAPSR 中的 DUL 位为 1。



在开始编程之前，应用程序可以校验 DUL 为是否被有效置 1 来确认DATA区域已经将写保护解锁。应用程序可以再任意时刻通过清 DUL 位来重新禁止对 DATA 区域的写操作。



#### 3、对选项字节的写操作

​     

对选项字节的写操作的步骤和对 DATA EEPROM 的操作大致相同。但是要注意到 FLASH_CR2 中的 OPT 位要为 1 以及 FLASH_NCR 中的 NOPT 位要为 0，这样才可以对选项字节进行写操作。



---

### 存储器编程



在尝试任何编程操作之前，必须对主程序寄存器和 DATA 区域解锁。



#### 1、读同时写（RWW）



RWW 特性允许用户在执行程序和读程序存储器时对 DATA EEPROM 区域进行写操作，因此执行的时间被优化了。相反的操作是不允许的：不可以在写程序寄存器时对 DATA EEPROM 进行读操作。



RWW 特性是一直有效的而且可以在任意时刻使用。



并不是所有 stm8 器件都有 RWW 特性。



#### 2、字节编程



可以对主程序存储器和 DATA 区域逐字节地编程。要对一个字节编程，应用程序可直接向目标地址写入数据。



- 在主程序存储器中

​     当字节编程操作执行时，应用程序停止运行。

- 在DATA区域中

​     有 RWW 功能的器件： 在 IAP 模式下，应用程序不停止运行，字节编程利用 RWW 功能进行操作。

​     无 RWW 功能的器件：当字节编程操作执行时，应用程序停止运行。要擦除一个字节，向对应的字节简单写入 0x00 即可。



应用程序可以通过读 FLASH_IAPSR 寄存器来校验编程或擦出操作是否已被正确执行：

- 在一次成功的编程操作后 EOP 位被置 1。

- 当软件试图对一个被保护的页进行写操作时 WP_PG_DIS 位被置 1。在这种情况下，写操作不会被执行。



如果 FLASH_CR1 中的 IE 位已经被预先使能，则只要这些标志位（EOP/WP_PG_DIS）中有一个被置位就会产生一个中断。



#### 自动快速字节编程



根据目标地址的初始化内容的不同，编程持续时间可能也有所不同。如果字（4 个字节）中包含不为空的字节，在编程前整个字节会被自动擦除。相反，如果字为空，由于不会执行擦除操作从而编程时间变短（参考 tPROG）。



然而，可以通过对 FLASH_CR1 中的 FIX 位置 1 来强迫执行系统擦除操作而不管其内容是否为空，从而使编程时间固定（参考 FLASH 控制寄存器）。编程总时间随之被规定位擦除时间和写操作时间的和。



为了快速写一个字节（没有擦除操作），将要被写入数据的整个字（4 个字节）必须被预先擦除。因此不可能对同一个字做连续两次快速写操作（在第二次写之前没有擦除操作）：第一次写字节操作将是快速操作但针对另外一个字节的第二次写操作将需要一个擦除操作。



#### 3、字编程



字写入操作允许一次对整个 4 字节的字进行编程，从而将编程时间缩短。



主程序存储器和 DATA EEPROM 都可以进行字操作。在一些 stm8s 器件中，也拥有当 DATA EEPROM 在进行写操作时同时具备 RWW 功能。



为了对一个字编程，FLASH_CR2 和 FLASH_NCR2 中的 WPRG/NWPRG 位必须预先置位/清零来使能字编程模式。然后将要被编程字的 4 个字节必须被从首地址开始装载。当四个字节都被写入后，编程周期自动开始。



像字节操作一样，FLASH_IAPSR 中的 EOP 与 WR_PG_DIS 控制位和 FLASH 中断相配合，可用于检查操作是否被正确执行完毕。



#### 4、块编程



块编程比字节编程和字编程都要快。在块编程操作中，整个块的编程或擦除在一个编程周期就可以完成。



在主程序存储器和 DATA 区域都可以执行块操作。



- 在主程序存储器中

​     用于块编程的代码必须全部在 RAM 中执行。

- 在 DATA 区域中

​     有 RWW 功能的器件：DATA 块操作可在主程序存储器中执行，然而数据装载阶段必须在 RAM 中执行。

​     无 RWW 功能的器件：用于块编程的代码必须全部在 RAM 中执行。

​     

一共有三种可能的块操作：

- 块编程（也叫标准块编程）：整个块在编程前被自动擦除

- 快速块编程：在编程前没有预先的块擦除操作。

- 块擦除。



在块擦除时，中断被硬件自动屏蔽。



##### 标准块编程



块编程操作允许一次对整个进行编程，整个块在编程前被自动擦除。



为了对整个块编程，FLASH_CR2 和 FLASH_NCR2 中的 PRG/NPRG 位必须预先置位/清零来使能标准块编程。然后需要向主程序存储器或 DATA 区域的目标地址依次写入要编程的数据，这样数据会被锁存在内部缓存中。为编程整个块，块中的所有字节都需要被写入数据。但要注意，所有被写入缓存的数据必须位于同一个块中，这意味着这些数据必须有同样的高位地址：仅仅低 6 位的地址可以不一样。当目标块的最后一个字节被装载到缓存后，编程就自动开始了。编程前首先会自动执行一次擦除操作。



当对 DATA 区域进行块编程时，应用程序可以检查 FLASH_IAPSR 中的 HVOFF 位确认编程状态。一旦 HVOFF 被置 0，真正的编程阶段就开始了，此时应用程序就可以返回到主程序中去了。



FLASH_IAPSR 中的 EOP 与 WR_PG_DIS 控制位和 FLASH 中断相配合，可用于检查操作是否被正确执行完毕。



##### 快速块编程



快速块编程允许不擦除存储器内容就对块进行编程，因此快速块编程速度是标准块编程的两倍。



该模式仅用于被编程部分已经被擦除过的情况，同时这种模式对向空白部分写入完整的应用代码特别有用，因为这种模式可以节省相当可观的时间。



快速块编程的步骤和标准块编程的步骤大致一样，FLASH_CR2 和 FLASH_NCR2 中的 FPRG/NFPRG 位必须预先置位/清零来使能快速块编程。



FLASH_ISPSR 中的 EOP 与 WR_PG_DIS 控制位和 FLASH 中断相配合，可用于检查快速块编程操作是否被正确执行完毕。



**警告**：在执行快速块编程之前如果这个块不是空的话，不能保证写入的数据无误。



##### 块擦除



块擦除允许擦除整个块。



为了擦除整个块，FLASH_CR2 和 FLASH_NCR2 中的 ERASE/NERASE 位必须预先置位/清零来使能块擦除。通过对块中所有的字写入 0x00 00 00 00 来擦除整个块。字的起始地址必须以 0，4，8 或 C 作为结尾。



FLASH_IARSR 中的 EOP 与 WR_PG_DIS 控制位和 FLASH 中断相配合，可用于检查操作是否被正确执行完毕。

![Image.png](https://i.loli.net/2019/03/03/5c7b3e3b76994.png)



#### 5、选项字节（Option byte）编程



对选项字节编程和对 DATA EEPROM 区域编程非常相似。



应用程序可直接向目标地址进行写操作。利用 stm8 的 RWW 功能，在对选项字节写操作的同时程序不必挺下来。



---

### ICP 和 IAP



在线编程（ICP）用于更新整个存储器的内容。ICP 使用 SWIM 接口把用户的程序装载到微控制器中，同时提供迅速而有效的设计迭代并且去除了不必要的封装处理和器件插槽。SWIM 接口（单线接口模块）使用 SWIM 引脚和编程工具相连接。



相对于 ICP 方式，在应用编程（IAP）可使用 stm8 支持的任意通讯接口（I/O、I2C、SPI、UART…）来下载要编入存储器中的数据。IAP 允许在应用程序运行中对 FLASH 程序存储器的内容重新编程。然而要想使用 IAP，必须通过 ICP 对 FLASH 程序存储器预先编程。



stm8 FLASH 编程手册 RM0051，stm8 SWIM 通信协议和调试模块用户手册 UM0470。



![Image.png](https://i.loli.net/2019/03/03/5c7b3e7a4b4db.png)



---

### FLASH寄存器



FLASH控制寄存器1（FLASH_CR1）

FLASH控制寄存器2（FLASH_CR2）

FLASH互补控制寄存器2（FLASH_NCR2）

FLASH保护寄存器（FLASH_FPR）

FLASH保护寄存器（FLASH_NFPR）

FLASH程序存储器解保护寄存器（FLASH_PUKR）

DATA EEPROM解保护寄存器（FLASH_DUKR）

FLASH状态寄存器（FLASH_IAPSR）



![Image.png](https://i.loli.net/2019/03/03/5c7b3ebdd90dd.png)



