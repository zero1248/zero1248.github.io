---
title: STM32 时钟树总结
tags:
  - 硬件拾忆
  - STM32
abbrlink: 19efc0ad
date: 2019-03-04 09:48:27
---

---

### 一、时钟源



#### 1、物理时钟源



看到好多地方都说 STM32F1 有五个时钟源 HSE、HSI、LSI、LSE 和 PLL，但是我觉得 PLL 严格来讲不算一个时钟源，它是在基本的物理时钟上倍频得到的，因此我把 HSE、HSI、LSI、LSE 归结为 STM32F1 的四个基本物理时钟源。



<!--more-->



![Image.png](https://i.loli.net/2019/03/04/5c7c85c0784c9.png)



STM32F1xx 有 4 个物理时钟源：

- HSE（High Speed External clock signal）4-16MHz

- HSI（High Speed Internal clock signal） 8MHz

- LSI（Low Speed Internal clock signal） 40kHz            驱动独立看门狗 IWDG 和 AWU

- LSE（Low Speed External clock signal）32.768kHz     驱动RTC



其中 HSE 和 HSI 可经 PLL 倍频得到 PLL 高频时钟源（最大 72M）。



##### （1）高速外部时钟信号（HSE）

​     由以下两种时钟源产生：

·    HSE 外部晶体/陶瓷谐振器

·    HSE 用户外部时钟



![Image.png](https://i.loli.net/2019/03/04/5c7c842945450.png)



**外部时钟源（HSE旁路）**



在这个模式里，必须提供外部时钟。它的频率最高可达 25MHz。用户可通过设置在控制寄存器中的 HSEBYP 和 HSEON 位来选择这一模式。外部时钟信号（50% 占空比的方波、正弦波或三角波）必须连到 OSC_IN 引脚，同时保证 OSC_OUT 引脚悬空，如上图。



**外部晶体/陶瓷谐振器（HSE晶体）**



4~16MHz 外部振荡器可为系统提供更为精确的主时钟。相关的硬件配置参考上图（关于晶体/陶瓷谐振器的原理，或者遇到晶振不起振的问题，可以参考下皮尔斯振荡器）。为了减少时钟输出的失真和缩短启动稳定时间，晶体/陶瓷谐振器和负载电容器必须尽可能地靠近振荡器引脚。负载电容值必须根据所选择的振荡器来选择。时钟控制寄存器 RCC_CR 中的 HSERDY 位用来指示高速外部振荡器是否稳定。在启动时，知道这一位被硬件置“1”,时钟才被释放。如果在时钟中断寄存器 RCCC_CIR 中允许产生中断，将会产生相应中断。HSE 晶体可以通过设置时钟控制寄存器里 RCC_CR 中的 HSEON 位被启动和关闭。



##### （2）高速内部时钟信号（HSI）



HSI 时钟信号由内部 8MHz 的 RC 振荡器产生，可直接作为系统时钟或在 2 分频后作为 PLL 输入（此时最大 64M）。HSI RC 振荡器能在不需要任何外部器件的条件下提供系统时钟。它的启动时间比 HSE 晶体振荡器短。然而，即使在校准之后它的时钟频率精度仍较差。

​     

**HSI 校准：**

制造工艺决定了不同芯片的 RC 振荡器频率会不同，这就是为什么每个芯片的 HSI 时钟频率在出厂前已经被 ST 校准到 1%（25℃）的原因。系统复位时，工厂校准值被装在到时钟控制器的 HSICAL[7:0] 位。如果用户的应用基于不同的电压或环境温度，这将会影响 RC 振荡器的精度。可以通过时钟控制寄存器里的 HSITRIM[4:0] 位来调整 HSI 频率。



时钟控制寄存器中的 HSIRDY 位用来指示 HSI RC 振荡器是否稳定。在时钟启动过程中，知道这一位被硬件置“1”,HSI RC 输出时钟才被释放。HSI RC 可由时钟控制寄存器中的 HSION 位来启动和关闭。



如果 HSE 晶体振荡器失效，HSI 时钟会被作为备用时钟源。

​     

##### （3）低速外部时钟信号（LSE）



LSE 晶体是一个 32.768kHz 的低速外部晶体或陶瓷谐振器。它为实时时钟或其他定时功能提供一个低功耗且精确的时钟源。



LSE 晶体通过在备份域控制寄存器（RCC_BDCR）里的 LSEON 位启动和关闭。



在备份域控制寄存器（RCC_BDCR ）里的 LSERDY 指示 LSE 晶体振荡是否稳定。在启动阶段，知道这个位被硬件置 1 后，LSE 时钟信号才被释放出来。如果在时钟中断寄存器里被允许，可产生中断申请。



**外部时钟源（LSE旁路）**

在这个模式里必须提供一个 32.768kHz 频率的外部时钟源。可以通过设置在备份域控制寄存器（RCC_BDCR）里的 LSEBYP 和 LSEON 位来选择这个模式。具有 50% 占空比的外部时钟信号（方波、正弦波或三角波）必须连到 OSC32_IN 引脚，同时保证 OSC32_OUT 引脚悬空。

​     

##### （4）低速内部时钟信号（LSI）



LSI RC 担当一个低功耗时钟源的角色，它可以在停机和待机模式下保持运行，为独立看门狗和自动唤醒单元提供时钟。LSI 时钟频率大约 40kHz（在 30kHz 到 60kHz 之间）。



LSI RC 可以通过控制/状态寄存器（RCC_CSR）里的 LSION 位来启动或关闭。



在控制/状态寄存器（RCC/CSR）里的 LSIRDY 位指示低速内部振荡器是否稳定。在启动阶段，知道这个位被硬件置 1 后，此时钟才被释放。如果在时钟中断寄存器（RCC_CIR）里被允许，将产生 LSI 中断申请。



**LSI 校准：（只有大容量和互联型产品可以进行 LSI 校准）**

可以通过校准内部低速振荡器 LSI 来补偿其频率便宜，从而获得精度可接受的 RTC 时间基数，以及独立看门狗 IWDG 的超时时间（当这些外设以 LSI 为时钟源）。

校准可以通过使用 TIM5 的输入时钟（TIM5_CLK）测量 LSI 时钟频率实现。测量以 HSE 的精度为保证，软件可以通过调整 RTC 的 20 位预分频器来获得精确的 RTC 时钟基数，以及通过计算得到精确的独立看门狗 IWDG 的超时时间。



LSI 校准步骤如下：

- 打开 TIM5，设置通道 4 为输入捕获模式；

- 设置 AIFO_MAPR 的 TIM5_CH4_IREMAP 位为 1，在内部把 LSI 连接到 TIM5 的通道 4；

- 通过 TIM5 的捕获/比较 4 事件或者中断来测量 LSI 时钟频率；

- 根据测量结果和期望的 RTC 时间基数和独立看门狗的超时时间，设置 20 位预分频器。



##### （5）PLL



内部 PLL 可以用来倍频 HSI RC 的输出时钟或 HSE 晶体输出时钟。PLL 的设置（选择 HSI 振荡器除以2或者 HSE 振荡器为 PLL 输入时钟，和选择倍频因子）必须在其被激活前完成。一旦 PLL 被激活，这些参数就不能被改动。



如果 PLL 中断在时钟中断寄存器里被允许，当 PLL 准备就绪时，可产生中断申请。



如果需要在应用中使用 USB 接口，PLL 必须被设置为输出 48 或 72MHz 时钟，用于提供 48MHz 的 USBCLK 时钟。



#### 2、系统时钟 SYSCLK



STM32 的系统时钟 SYSCLK 由 SW 控制，从 HSI、PLLCLK 和 HSE 中三选一，通常选 PLLCLK。系统刚上电 的时候，使用系统内部 8MRC 时钟。SYSCLK 最大 72MHz，也可超频至 128MHz，但不建议。若使用 HSI 经 PLL 作为 SYSCLK，最大 64MHz，因为先 2 分频，PLL 最大只能 16 倍频。



系统复位后，HSI 振荡器被选为系统时钟。当时钟源被直接或通过 PLL 间接作为系统时钟时，它将不能被停止。



只有当目标时钟源准备就绪了，从一个时钟源到另一个时钟源的切换才会发生。在被选择时钟源没有就绪时，系统时钟的切换不会发生。直至目标时钟源就绪，才发生切换。



在时钟控制寄存器（RCC_CE）里的状态位指示哪个时钟已经准备好了，哪个时钟目前被用作系统时钟。



### 二、时钟分配



#### 1、SYSCLK



系统时钟 SYSCLK，它是供 STM32 中绝大部分部件工作的时钟源。系统时钟可选择为 PLL 输出、HSI 或者 HSE。系统时钟最大频率为 72MHz，它通过 AHB 分频器分频后送给各模块使用，AHB 分频器可选择 1、2、4、8、16、64、128、256、512 分频。其中 AHB 分频器输出的时钟送给 5 大模块使用：



- 送给 AHB 总线、内核、内存和 DMA 使用的 HCLK 时钟。

- 通过 8 分频后送给 Cortex 的系统定时器时钟 SYSTICK。

- 直接送给 Cortex 的空闲运行时钟 FCLK。

- 送给 APB1 分频器。APB1 分频器可选择 1、2、4、8、16 分频，其输出一路供 APB1 外设使用(PCLK1，最大频率 36MHz)，另一路送给定时器 (Timer)2、3、4 倍频器使用。该倍频器可选择1 或者 2 倍频，时钟输出供定时器 2、3、4 使用。

- 送给 APB2 分频器。APB2 分频器可选择 1、2、4、8、16 分频，其输出一路供 APB2 外设使用(PCLK2，最大频率 72MHz)，另一路送给定时器 (Timer)1 倍频器使用。该倍频器可选择 1 或者 2 倍频，时钟输出供定时器 1 使用。另外，APB2 分频器还有一路输出供 ADC 分频器使用，分频后送给 ADC 模块使用。ADC 分频器可选择为 2、4、6、8 分频。



在以上的时钟输出中，有很多是带使能控制的，例如 AHB 总线时钟、内核时钟、各种 APB1 外设、 APB2 外设等等。当需要使用某模块时，记得一定要先使能对应的时钟。



#### 2、具体时钟分配



CM3 的系统滴答时钟 SYSTICK，来源是 AHB 分频后再 8 分频，通常设置 AHB 不分频，所以 SYSTICK 的频率就是 SYSCLK/8。



APB1（低速APB）总线上的外设时钟 PCLK1，最大为 36MHz，所有挂载在 APB1 上的外设，最大时钟都是 36MHz，定时器除外。PCLK1 的时钟由 APB1 预分频器设置，默认 2 分频（72MHz/2）。挂在这一总线的外设有： 电源接口、备份接口、CAN、USB、I2C1、I2C2、UART2~5、SPI2、SPI3、窗口看门狗(WWDG)、Timer2~7。注意 USB 模块虽然需要一个单独的 48MHz 时钟信号，但它应该不是供 USB 模块工作的时钟，而只是提供给串行接口引擎(SIE)使用的时钟。



APB2（高速 APB）总线上的外设时钟 PCLK2，最大为 72MHz，所有挂载在 APB2 上的外设，最大时钟都是 72MHz。PCLK2 的时钟由 APB2 预分频器设置，默认不分频。挂在这一总线的外设有：UART1、GPIOA~G、SPI1、ADC1~3、高级定时器（1、8）第二功能 IO 口。



SDIO 接口的时钟频率固定为 HCLK/2。



ADC 时钟由高速 APB2 时钟经 2、4、6 或 8 分频获得。



如果相应的 APB 预分频系数是 1，定时器时钟频率与所在 APB 总线频率一致，否则为与其相连的 APB 总线频率的 2 倍

​     

FCLK 是 CM3 的自由运行时钟。



STM32 中有一个全速功能的 USB 模块，其串行接口引擎需要一个频率为 48MHz 的时钟源。该时钟源只能从 PLL 输出端获取，可以选择为 1.5 分频或者 1 分频，也就是，当需要使用 USB 模块时，PLL 必须使能，并且时钟频率配置为 48MHz 或 72MHz。



#### 3、时钟安全系统（CSS）



时钟安全系统可以通过软件激活。一旦其被激活，时钟监测器将在 HSE 振荡器启动延迟后被使能，并在 HSE 时钟关闭后关闭。



如果 HSE 时钟发生故障，HSE 振荡器被自动关闭，时钟失效事件将被送到高级定时器（TIM1 和 TIM8）的刹车输入端，并产生时钟安全中断 CSSI，允许软件完成营救操作。此 CSSI 中断连接到 Cortex-M3 的 NMI 中断。



一旦 CSS 被激活，并且 HSE 时钟出现故障，CSS 中断就产生，并且 NMI 也自动产生。NMI 将被不断执行，知道 CSS 中断挂起位被清除。因此，在NMI的处理程序中必须通过设置时钟中断寄存器（RCC_CIR）里的 CSSC 位来清除 CSS 中断。



如果 HSE 振荡器被直接或间接地作为系统时钟，（间接是指作为 PLL 输入时钟而 PLL 时钟作为系统时钟），时钟故障将导致系统时钟自动切换到 HSI 振荡器，同时外部 HSE 振荡器被关闭。在时钟失效时，如果 HSE 振荡器时钟（被分频或未被分频）是用作系统时钟的 PLL 的输入时钟，PLL 也将被关闭。



#### 4、RTC 时钟



通过设置备份域控制寄存器（RCC_BDCR）里的 RTCSEL[1:0] 位，RTCCLK 时钟源可以有 HSE/128、LSE 或 LSI 时钟提供。除非备份域复位，此选择不能被改变。



LSE 时钟在备份域里，但 HSE 和 LSI 时钟不是。因此：

- 如果 LSE 被选为 RTC 时钟：
  - 只要 VBAT 维持供电，尽管 VDD 供电被切断，RTC 仍继续工作。

- 如果 LSI 被选为自动唤醒单元（AWU）时钟：
  - 如果 VDD 供电被切断，AWU 状态不能被保证。

- 如果 HSE 时钟 128 分频后作为 RTC 时钟：
  - 如果 VDD 供电被切断或内部电压调压器被关闭（1.8V 域的供电被切断），则 RTC 状态不确定。
  - 必须设置电源控制寄存器的 DPB 位为 1（取消后备区域的写保护）。



#### 5、看门狗时钟



如果独立看门狗已经由硬件选项或软件启动，LSI 振荡器将被强制在打开状态，并且不能被关闭。在 LSI 振荡器稳定后，时钟供应给 IWDG。



---

### 三、时钟输出



STM32 可以选择一个时钟信号输出到 MCO 脚(PA8)上，可以选择为 PLL 输出的 2 分频、HSI、HSE、或者 SYSCLK。



---

### 四、相关寄存器



（1）时钟控制寄存器（RCC_CR）初始化用

（2）时钟配置寄存器（RCC_CFGR）初始化用

（3）时钟中断寄存器（RCC_CIR）

（4）APB2 外设复位寄存器（RCC_APB2RSTR）

（5）APB1 外设复位寄存器（RCC_APB1RSTR）

（6）AHB 外设时钟使能寄存器（RCC_AHBENR）

（7）APB2 外设时钟使能寄存器（RCC_APB2ENR）

（8）APB1 外设时钟使能寄存器（RCC_APB1ENR）

（9）备份域控制寄存器（RCC_BDCR）

（10）控制/状态寄存器（RCC_CSR）

（11）RCC 寄存器地址映像



RCC 地址：0x4002 1000-0x4002 13ff







