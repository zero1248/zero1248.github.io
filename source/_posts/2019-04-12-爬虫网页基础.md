---
title: 爬虫网页基础
date: 2019-04-12 00:00:26
tags:
    - CS基础
---

---

《Python 网络爬虫开发实战（崔庆才著）》笔记

---

#### 一、HTTP 基本原理

##### 1、URI 和 URL

<!--more-->

- URI（Uniform Resource Identifier，统一资源标志符）
- URL（Universal Resource Locator，统一资源定位符）

URI 包括 URL 和 URN（Universal Resource Name，统一资源名称），URL 是 URI 的子集。

URN 用的较少，所以几乎所有的 URI 都是 URL。

URL/URI 唯一指定一个资源，包括：
- 访问协议
- 访问路径（根目录）
- 资源名称

##### 2、超文本

网页的源代码就可以称作超文本。

##### 3、HTTP 和 HTTPS

常见协议类型：
- http（Hyper Text Transfer Protocol）
- https（Hyper Text Transfer Protocol over Secure Socket Layer）
- ftp
- sftp
- smb

爬虫主要爬取 http 或 https 协议。

http 协议用于从网络传输超文本数据到本地浏览器的传送协议，能保证高效而准确地传送超文本文档。

https 协议是以安全为目标的 HTTP 通道，在 HTTP 下加入 SSL 层，是 HTTP 的安全版。

SSL 的主要作用有两种：
- 建立一个信息安全通道来保证数据传输的安全
- 确认网站的真实性，使用 HTTPS 的网站，都可以点击浏览器地址栏的锁头标志来查看网站认证之后的真实信息，也可通过 CA 机构颁发的安全签章来查询

某些网站虽使用了 HTTPS 协议，但证书不是被 CA 机构认证的，爬取时需要设置忽略证书的选项，否则会提示 SSL 连接错误。

##### 4、HTTP 请求过程

浏览器中输入一个 URL，按下回车之后，浏览器向网站所在的服务器发送一个请求，网站服务器接收到请求后进行解析和处理，然后返回对应的响应，接着传回给浏览器。响应里包含了页面的源代码等内容。


##### 5、请求

请求由客户端向服务器发出，可分为 4 部分内容：
- 请求方法（Request Method）
- 请求的网址（Request URL）
- 请求头（Request Headers）
- 请求体（Request Body）

**（1）请求方法**

| 方法     | 描述                                                    |
| -------- | ------------------------------------------------------- |
| GET      | 请求页面，并返回页面内容                                |
| HEAD     | 类似 GET 请求，但返回的响应中没有具体内容，用于获取报头 |
| POST     | 大多用于提交表单或上传文件，数据包含在请求体中          |
| PUT      | 从客户端向服务器传送的数据取代指定文档中的内容          |
| DELETE   | 请求服务器删除指定的页面                                |
| CONNECT  | 把服务器当跳板，让服务器代替客户端访问其他网页          |
| OPTINONS | 允许客户端查看服务器的性能                              |
| TRACE    | 回显服务器收到的请求，主要用于测试或诊断                |

其中常用的是 GET 和 POST。

在浏览器直接输入 URL 并回车，发起的是 GET 请求。

POST 请求大多在表单提交时发起。如登录时需要提交用户名和密码，如果用 GET 方法，密码将暴露在 URL 中，又或者上传文件时，由于文件内容较大，也会选用 POST 方式。

GET 和 POST 请求方法的区别为：
- GET 请求中的参数包含在 URL 里，数据可以在 URL 中看到。POST 请求的 URL 不会包含这些数据，数据都是通过表单形式传输的，会包含在请求体中
- GET 请求提交的数据最多只有 1024 字节，而 POST 方式没有限制。

**（2）请求的网址**

即 URL，唯一确定欲请求的资源。

**（3）请求头**

用于说明服务器要使用的附加信息。常用的头信息有：
- Accept：请求报头域，用于指定客户端可接受哪些类型的信息
- Accept-Language：指定客户端可接受的语言类型
- Accept-Encoding：指定客户端可接受的内容编码
- Cookies：网站为了辨别用户进行会话跟踪而存储在用户本地的数据，主要功能是维持当前访问对话
- Referer：用于标识这个请求是从哪个页面发来的，服务器可拿到这一信息并做相应处理，如做来源统计、防盗链处理等
- User-Agent：用户代理（UA），可使服务器识别客户使用的操作系统及版本、浏览器及版本等信息。做爬虫时加上此信息，可伪装成浏览器
- Content-Type：也叫互联网媒体类型或者 MIME 类型，在 HTTP 协议消息头中，用来表示具体请求中的媒体类型信息

**（4）请求体**

一般承载的内容是 POST 请求中的表单数据，GET 请求的请求体为空

Content-Type 和 POST 提交数据方式的关系

| Content-Type                      | 提交数据的方式   |
| --------------------------------- | ---------------- |
| application/x-www-form-urlencoded | 表单数据         |
| multipart/form-data               | 表单文件上传     |
| application                       | 序列化 JSON 数据 |
| text/xml                          | XML 数据         |

##### 6、响应

响应由服务器端返回给客户端，可分为三部分：
- 响应状态码（Response Status Code）
- 响应头（Response Headers）
- 响应体（Response Body）

（1）响应状态码


| 状态码 | 说明            | 详情                                                         |
| ------ | --------------- | ------------------------------------------------------------ |
| 1XX    |                 |                                                              |
| 100    | 继续            | 请求者应当继续提出请求。服务器已收到请求的一部分，正在等待其余部分 |
| 101    | 切换协议        | 请求者已要求服务器切换协议，服务器已确认并准备切换           |
| 2XX    |                 |                                                              |
| 200    | 成功            |                                                              |
| 201    | 已创建          |                                                              |
| 202    | 已接受          |                                                              |
| 203    | 非授权信息      |                                                              |
| 204    | 无内容          |                                                              |
| 205    | 重置内容        |                                                              |
| 206    | 部分内容        |                                                              |
| 3XX    |                 |                                                              |
| 300    | 多种选择        |                                                              |
| 301    | 永久移动        |                                                              |
| 302    | 临时移动        |                                                              |
| 303    | 查看其他位置    |                                                              |
| 304    | 未修改          |                                                              |
| 305    | 使用代理        |                                                              |
| 307    | 临时重定向      |                                                              |
| 4XX    |                 |                                                              |
| 400    | 错误请求        |                                                              |
| 401    | 未授权          |                                                              |
| 403    | 禁止访问        |                                                              |
| 404    | 未找到          |                                                              |
| 405    | 方法禁用        |                                                              |
| 406    | 不接受          |                                                              |
| 407    | 需要代理授权    |                                                              |
| 408    | 请求超时        |                                                              |
| 409    | 冲突            |                                                              |
| 410    | 已删除          |                                                              |
| 411    | 需要有效长度    |                                                              |
| 412    | 未满足前提条件  |                                                              |
| 413    | 请求实体过大    |                                                              |
| 414    | 请求 URI 过长   |                                                              |
| 415    | 不支持类型      |                                                              |
| 416    | 请求范围不符    |                                                              |
| 417    | 未满足期望值    |                                                              |
| 5XX    |                 |                                                              |
| 500    | 服务器内部错误  | 服务器遇到错误，无法完成请求                                 |
| 501    | 未实现          | 服务器不具备完成请求的功能                                   |
| 502    | 错误网关        | 服务器作为网关或代理，从上游服务器收到无效响应               |
| 503    | 服务不可用      | 服务器目前无法使用                                           |
| 504    | 网关超时        | 服务器作为网关或代理，但是没有及时从上游服务器收到请求       |
| 505    | HTTP 版本不支持 |                                                              |

（2）响应头

响应头包含了服务器对请求的应答信息，如 Content-Type、Server、Set-Cookie 等。常用的响应头信息：
- Date：标识响应产生的时间
- Last-modified：指定资源的最后修改时间
- Content-Encoding：指定响应内容的编码
- Server：包含服务器的信息，比如名称、版本号等
- Content-Type：文档类型，指定返回的数据类型，text/html 代表返回 HTML 文档，application/x-javascript 代表返回 JavaScript 文件，image/jpeg 代表返回图片
- Set-Cookie：设置 Cookies。响应头中的 Set-Cookie 告诉浏览器需要将此内容放在 Cookies 中，下次请求携带 Cookies 请求
- Expires：指定响应的过期时间，可以使代理服务器或浏览器将加载的内容更新到缓存中。如果再次访问时，就可以直接从缓存中加载，降低服务器负载，缩短加载时间

（3）响应体

存放响应的正文数据。比如请求网页时，响应体就是网页的 HTML 代码；请求图片时，响应体就是图片的二进制数据。

爬虫请求网页后，要解析的内容就是响应体。

---
#### 二、网页基础

##### 1、网页的组成

网页可分为三大部分
- HTML，定义网页的内容和结构
- CSS，描述网页的布局
- JavaScript，定义网页的行为

（1）HTML

Hyper Text Markup Language，即超文本标记语言。HTML 定义了网页的结构。

不同类型的元素通过不同类型的标签来表示，如图片用 img，视频用 video，段落用 p。各种类型之间的布局又通过布局标签 div 嵌套组合而成。

（2）CSS

Cascading style Sheets，即层叠样式表。“层叠”是指当在 HTML 中引用了数个样式文件，并且样式发生冲突时，浏览器能依据层叠顺序处理。“样式”指网页中文字大小、颜色、元素间距、排列等格式。

在网页中，一般统一定义整个网页的样式规则，并写入 CSS 文件中。在 HTML 中，只需要用 link 标签即可引入写好的 CSS 文件，这样整个页面就会变得美观、优雅。

（3）JavaScript

简称 JS，是一种脚本语言。HTML 和 CSS 配合使用，提供给用户的只是一种静态信息，缺乏交互性。JS 的出现使得用户与信息之间不只是一种浏览与现实的关系，而是实现了一种实时、动态、交互的页面功能。

在 HTML 中通过 script 标签即可引入 .js 文件。

##### 2、网页的结构

一个网页的标准形式是 html 标签内嵌套 head 和 body 标签，head 内定义网页的配置和引用，body 内定义网页的正文。

##### 3、节点树及节点间的关系

在 HTML 中，所有标签定义的内容都是结点，它们构成了一个 HTML DOM 树。DOM 是 Document Object Model 即文档对象类型，它定义了访问 HTML 和 XML 文档的标准。

W3C DOM 标准被分为 3 个不同的部分：
- 核心 DOM：针对任何结构化文档的标准模型
- XML DOM：针对 XML 文档的标准模型
- HTML DOM：针对 HTML 文档的标准模型

根据 W3C 的 HTML DOM 标准，HTML 文档中的所有内容都是节点：
- 整个文档是一个文档节点
- 每个 HTML 元素是元素节点
- HTML 元素内的文本是文本节点
- 每个 HTML 属性是属性节点
- 注释是注释节点

通过 HTML DOM，树中的所有节点均可通过 JavaScript 访问，所有 HTML 节点元素均可被修改，也可被创建或删除。

##### 4、选择器

网页由一个个节点组成，CSS 选择器会根据不同的节点设置不同的样式规则。

在 CSS 中，使用 CSS 选择器来定位节点。

还有一种比较常用的选择器是 XPath。

---
#### 三、爬虫的基本原理

##### 1、爬虫概述

（1）获取网页

使用请求库获取网页的源代码。

（2）提取信息

从 Body 部分提取需要的数据，最通用的方法是采用正则表达式提取。

另外由于网页的结构有一定规则，所以还有一些根据网页节点属性、CSS 选择器或者 Xpath 来提取网页信息的库，如 BeautifulSoup、pyquery、lxml 等。

（3）保存数据

可以简单保存为 TXT 文本或 JSON 文本，也可以保存到数据库，如 MySQL 或 MongoDB 等，也可以保存到远程服务器，如借助 SFTP 进行操作等。

（4）自动化程序

即爬虫可以替代人来完成这些操作。

##### 2、能抓怎样的数据

只要在浏览器里可以访问到的文件，都可以抓取下来。

##### 3、JavaScript 渲染页面

很多网页可能是由 JavaScript 渲染出来的，原始的 HTML 代码就是一个空壳。

JavaScript 会改变 HTML 中的节点，向其添加内容，最后得到完整的页面。

对于使用 JavaScript 渲染的网页，有时候得到的源代码和浏览器看到的不一样，因此使用基本 HTTP 请求库得到的源代码可能跟浏览器中的页面源代码不太一样，可以分析其后台 Ajax 接口，也可以使用 Selenium、Splash 这样的库来模拟 JavaScript 渲染。

---
#### 四、会话和 Cookies

##### 1、静态网页和动态网页

- 静态网页 —— 由 HTML 代码编写，文字、图片等内容均通过写好的 HTML 代码来指定。
- 动态网页 —— 可以动态解析 URL 中参数的变化，关联数据库并动态呈现不同的页面内容，非常灵活多变。

动态网站可还以实现用户登录和注册的功能。

##### 2、无状态 HTTP

HTTP 的无状态是指 HTTP 协议对事务处理是没有记忆能力的，也就是说服务器不知道客户端是什么状态。于是出现了两个用于保持 HTTP 连接状态的技术：
- 会话
    - 在服务器端，用来保存用户的会话信息
    - 会话对象用于存储特定用户会话所需的属性及配置信息
    - 用户在应用程序的 Web 页之间跳转时，存储在会话对象中的变量不会丢失
    - 用户请求 Web 页时，如果还没有会话，Web 服务器将自动创建一个会话对象，当会话过期或被放弃后，服务器将终止该会话
- Cookies
    - 在客户端，是某些网站为了辨别用户身份、进行会话跟踪而存储在用户本地终端上的数据。
    - 浏览器在下次访问网页时会自动附带上 Cookies 发送给服务器，服务器通过识别 Cookies 并鉴定出是哪个用户，在判断用户是否是登录状态，然后返回对应的响应
    - Cookies 是客户第一次请求服务器时，由服务器返回一个请求头中带有 Set-Cookie 字段的响应给客户端，用来标记是哪一个用户，客户端浏览器会把 Cookies 保存起来。


会话 Cookie 和持久 Cookie：
- 会话 Cookie 就是把 Cookie 放在浏览器内存里，浏览器在关闭之后该 Cookie 即失效
- 持久 Cookie 则会保存到客户端的硬盘中，下次还可以继续使用，用于长久保持用户登录状态
  -严格来说，没有会话 Cookie 和持久 Cookie 之分，只是有 Cookie 的 Max Age 或 Expires 字段决定了过期的时间

##### 3、常见误区

关闭浏览器不会导致会话消失，所以需要服务器为会话设置一个失效时间。

---
#### 五、代理的基本原理

##### 1、基本原理

代理指代理服务器，英文叫作 proxy server，它的功能是代理网络用户去取得网络信息，是网络信息的中转站。

这个过程中 Web 服务器识别出的真实 IP 就不再是我们本机的 IP 了，就成功实现了 IP 伪装。

##### 2、代理的作用

- 突破自身 IP 访问限制，访问一些平时不能访问的站点
- 访问一些单位或团体内部资源
- 提高访问速度
- 隐藏真实 IP

##### 3、爬虫代理

使用代理隐藏真实的 IP，让服务器误以为是代理服务器在请求自己，这样在爬取过程中通过不断更换代理，就不会被封锁，可以达到很好的爬取效果。


##### 4、代理分类

根据协议区分：
- FTP 代理服务器
- HTTP dialing服务器
- SSL/TLS 代理
- RTSP 代理
- Telnet 代理。主要用于 telnet 远程控制（黑客入侵计算机时常用于隐藏身份），端口一般为23
- POP3/SMTP 代理
- SOCKS 代理。只是单纯传递数据包，不关心具体协议和用法，所以速度快很多，一般有缓存功能，端口一般为 1080

根据匿名程度区分：
- 高度匿名代理
- 普通匿名代理
- 透明代理。除了能用缓存技术提高浏览速度，能用内容过滤提高安全性之外，无其他显著作用，最常见的例子是内网中的硬件防火墙
- 间谍代理

##### 5、常见代理设置

- 使用网上的免费代理，最好使用高匿代理
- 使用付费代理服务，质量好
- ADSL 拨号，拨一次号换一次 IP，稳定性高