---
title: C++ 文件流输入输出
date: 2019-04-04 17:00:20
tags:
    - 编程语言
    - C++
---

---

头文件 fstream 定义了三个类来支持文件 IO：

- ifstream 从一个给定文件读取数据
- ofstream 向一个给定文件写入数据
- fstream 读写给定文件

<!--more-->

---
#### 一、创建对象及打开文件

##### 头文件
```
#include <fstream>
using namespace std;
```
fstream 文件使用 std 命名空间。

##### 创建文件流

读写一个文件时，可以定义一个文件流对象，并将对象与文件关联起来。每个文件流类都定义了一个名为 open 的成员函数，它完成一些系统相关的操作，来定位给定的文件，并视情况打开为读或写模式。

```
ifstream input(ifile); // 构造一个 ifstream 并打开给定文件
ofstream output;    // 输出文件流未关联任何文件
```
对象名字可以是任意有效名称，如以上的 input、output。

##### 打开文件

以下两种打开方式是等效的：

```
ifstream fin("in_test.txt");

ifstream fin;
fin.open("in_test.txt");
```
如果文件在其他文件夹中，可以使用绝对路径。注意绝对路径中的 '\\' 要转义替换成 '\\\\'。

使用 open 方法时，共可以设置三个参数：filename，mode，access。

mode 即打开方式，有以下常用值：
ios::app：　　　以追加的方式打开文件 　　
ios::ate：　　　文件打开后定位到文件尾，ios:app就包含有此属性 　　
ios::binary：　以二进制方式打开文件，缺省是文本方式　
ios::in：　　　 文件以输入方式打开(文件数据输入到内存) 
ios::out：　　　文件以输出方式打开(内存数据输出到文件) 　
ios::nocreate： 不建立文件，所以文件不存在时打开失败 　　
ios::noreplace：不覆盖文件，所以打开文件时如果文件存在失败 　　
ios::trunc：　　如果文件存在，把文件长度设为0

access 即打开文件的属性，有以下常用值：
0：普通文件，打开访问
1：只读文件
2：隐含文件
3：系统文件

##### 关闭文件流

使用 close() 方法关闭文件流。例如：

```
ifstream fin("in_test.txt");
fin.close();
```

---
#### 二、读写文本文件

##### 读文本文件

1、使用插入器（<<）

因为 istream/ostream 类分别是 ifstream/ofstream 类的基类，所以可以直接使用它们的方法。例如：

```
ifstream fin("in_test.txt");
string str;
fin >> str;
```
注：cin

上面的代码可以读取一行数据到字符串 str 中。如果出现空格，将读取到该行的空格位置。

2、使用文件流的 getline() 成员函数

ifstream 也有 getline() 成员函数，有两种重载形式：
```
istream& getline (char* s, streamsize n ); //读取最多 n 个字符保存在 s 对应的数组中，即使大小不够 n
istream& getline (char* s, streamsize n, char delim ); //读取最多 n 个字符保存在s对应的数组中，遇到 delim，或者读完一行，或字数达到限制则终止
```
最多读取 n 个字符，这 n 个字符包括结束符，如果 n 是 1，将只会得到一个 '\0'，而不会获取文件中的内容。

字符内容只能读到 char 型数组中。遇到空格或回车将结束读取，即使还没有到达设置的数量，即此方法只能读取一个 C 语言意义上的字符串。

3、使用 string 类的 getline() 成员函数

getline() 是 string 类的一种成员函数，共三个参数：流对象，string 对象，终止字符。一般如果终止字符不写，默认以回车符中止，能接受字符串中的空格。

```
string str;
ifstream input("in_test.txt");
getline(input, str);
```

需要包含 <string> 头文件。

##### 写文本文件

写文本文件常用析取器（>>），遇到空格即停止。

---
#### 三、读写二进制文件

##### 读二进制文件

1、使用 get() 函数读字符

有多种重载形式，可以读单字符，也可以读到字符串中

```
ifstream &get(char &ch);  // 将字符保存到 ch 中，遇文件尾返回空字符

int get();  // 返回字符，与文件尾返回 EOF

ifstream &get(char *buf,int num,char delim='\n');  // 将字符串保存到 buf 数组中，遇 delim 结束读取
```

2、使用 read() 函数读数据块

```
read(unsigned char *buf,int num);　
```
读 num 个字符到 buf 数组中。


##### 写二进制文件

1、使用 put() 函数写字符

```
ofstream &put(char ch)；
```

2、使用 write() 函数写数据块

```
write(const unsigned char *buf,int num);
```
从 buf 指向的位置，写 num 个字符到文件中，buf 的类型是 unsigned char*。

##### 可能用到的函数

可使用 streamsize gcount() 返回在对象上执行的最后一个未格式化输入操作提取的字符数。若未进行任何操作，则返回 0。若提取了一行 6 个字符，将返回 7（因为有换行符），若提取的是最后一行 6 个字符，将返回 6。

可使用 bool eof() 检测是否到达文件尾。

可使用 bool bad() 检测读写过程中是否发生错误。如文件未打开，或者设备无写入空间。

可使用 bool fail() 检测格式错误。也能检测 bad() 包含的错误类型。

可使用 bool good() 检测文件流状态。

可使用 clear() 重置其他状态检测成员函数。

---
#### 四、文件指针移动

C++ 中文件流指针分为读指针和写指针，用于改变指针位置的成员函数是 seekg() 和 seekp()。

seekg() 和 seekp() 有两种重载形式：


```
\\ 指向绝对位置，通常用于文本文件，也可用于二进制文件
seekg ( pos_type ab_pos );
seekp ( pos_type ab_pos );
```

```
\\ 使用 origin+origin 实现相对位置，最好只用于二进制文件
istream &seekg(off_type offset,seekdir ab_pos);
ostream &seekp(off_type offset,seekdir ab_pos);
```

streamoff 定义偏移量 offset 所能取得的最大值。

seek_dir 表示移动的基准位置，有以下枚举值：
ios::beg：　　文件开头　　
ios::cur：　　文件当前位置　　
ios::end：　　文件结尾

tellg() 和 tellp() 用于返回当前输入流或者输出流指针的位置。返回值类型是 pos_type。

---

#### 五、缓存同步

C++ 中对流对象进行操作时，不是直接将流对象与设备（如键盘、屏幕、存储器）直接联系起来，而是通过一个 streambuf 类型的缓存将二者联系起来。

将缓存中的内容输出到指定设备的过程称为同步（synchronization），同步发生在以下几种情况：

- 遇到流中特定的控制符时，如 endl 和 flush。二者都可以用在析取器语句中，flush 还可单独作为成员函数使用。
- 缓存区满时将自动同步。
- 文件关闭时，缓存将同步。
- 调用成员函数 sync()，缓存将同步。

---


#### 六、各种流类之间的关系

![1554368740541](https://i.loli.net/2019/04/04/5ca5c9f50056b.png)

basic_ios 是所有流类的基类 ios_base 的模板类。

在 ios_base 的基础上派生出 ios，又在 ios 基础上派生出其他类，详见上图。