---
title: STM32 F(S)MC 总线
tags:
  - 硬件拾忆
  - STM32
abbrlink: c21dfbe4
date: 2019-03-04 11:13:55
---

---

CPU 内置灵活的静态存储器控制器（FSMC），可以外扩总线型的存储器（如SRAM、NOR Flash）。FSMC 的英文全称为“Flexible static memory controller”。



所有的外部存储器共享控制器输出的地址、数据和控制信号，每个外部设备可以通过一个唯一的片选信号加以区分。FSMC 在任一时刻只访问一个外部设备。

<!--more-->



![Image.png](https://i.loli.net/2019/03/04/5c7c9846e4e2b.png)



注意： 上图中的有些信号是多个信号引到同一个 CPU 管脚。

比如 FSMC_NCE4_1 和 FSMC_NE3同时引到了 PG10 管脚。软件可配置 GPIO 和 FSMC 相关的寄存器进行选择。



从 FSMC 的角度看，可以把外部存储器划分为固定大小为 256M 字节的四个存储块（BLOCK），见下图。



![Image.png](https://i.loli.net/2019/03/04/5c7c988c991ba.png)



- 存储块 1 用于访问最多 4 个 NOR 闪存或 SRAM 存储设备。这个存储区被划分为 4 个 BANK 并有 4 个专用的片选 FSMC_NE[4:1]。 CPU 的数据手册将这个区命名为 NOR/PSRAM 区，其中 NOR 指 NOR Flash；PSRAM 指伪 SRAM，即接口封装为 SRAM 形式的动态 RAM（DRAM）。其实，这个区也可以直接用于 SRAM。
- 存储块 2 和 3 用于访问 NAND 闪存设备，每个存储块连接一个 NAND 闪存。
- 存储块 4 用于访问 PC 卡设备 每一个存储块上的存储器类型是由用户在配置寄存器中定义的。



HADDR 是需要转换到外部存储器的内部 AHB 地址线。HADDR[25:0] 已连接到 CPU 口线，对应 FSMC_A[25:0]。HADDR[27:26] 仅在 CPU 内部使用，没有连接到 CPU 口线。



HADDR[27:26] 位用于选择四个存储块之一：

![Image.png](https://i.loli.net/2019/03/04/5c7c98a311812.png)



HADDR 是字节地址，而存储器访问不都是按字节访问，因此接到存储器的地址线依存储器的数据宽度有所不同，如下表：

![Image.png](https://i.loli.net/2019/03/04/5c7c98bab02cd.png)



在同一时刻，CPU 只能访问一个外部总线设备（SRAM、NOR Flash、NAND Flash、LCD）。外部总线设备间的协调就靠 CS 片选信号进行的，也就是同一时刻，只有一个外设的片选信号为低。除了片选信号外，其它的地址线、数据线、控制线都是共用的。



当 SRAM 的片选为高电平时，也就是不被选中时，SRAM 的数据线 I/O15~I/O0 呈高阻状态，这样就不会影响其它总线设备的通信。