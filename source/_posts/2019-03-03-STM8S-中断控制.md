---
title: STM8S 中断控制
date: 2019-03-03 11:01:28
tags:
    - 硬件拾忆
    - STM8
---

---

### ITC 简介



#### 硬件中断管理



- 大多数 I/O 口都具有外部中断能力，有专用的中断向量，每个端口都可以设置边沿检测方式（上升/下降）。

- 外设中断能力

<!--more-->

#### 软件中断能力（TRAP）



使用复杂中断优先级和等级管理的嵌套或并发中断管理

- 最多 4 个软件可编程的嵌套等级

- 最多 32 个由硬件固定的中断向量

- 2 个不可屏蔽事件：RESET，TRAP

- 1 个不可屏蔽的最高级硬件中断（TLI）



#### 中断管理基



- CPU 的 CCR 寄存器的 l1 和 l0 位

- 软件优先级寄存器（ITC_SPRx）

- 复位向量地址 0x008000 在程序存储器的起始位置。在有 boot ROM 的器件中，复位初始化程序由 STMicroelectronics 编程在 ROM 中。

- 固定的中断向量地址位于存储器地址映射的高地址（0x00 8004 到 0x00 807C），按硬件优先级顺序排列。



---

### 中断屏蔽和处理流程



中断屏蔽由 CCR 寄存器的 l1 和 l0 位和设置每个中断向量的软件优先级等级的 ITC_SPRx 寄存器管理。



![Image.png](https://i.loli.net/2019/03/03/5c7b55bed9fc8.png)



当一个中断请求必须被响应时：

1、正常的过程被暂停在当前指令执行的最后一条。

2、PC，X，Y，A 和 CCR 寄存器入栈。

3、CCR 寄存器的 l1 和 l0 位根据 ITC_SPRx 寄存器中相应的中断向量的值置位。

4、PC 然后载入中断的中断向量，以响应中断，取指中断服务函数的第一条指令。



中断服务函数应该以IRET指令结束，这条指令使得保存的寄存器值从栈中恢复。IRET 指令也会是 l1 和 l0 从栈中恢复，同时程序恢复正常执行过程。



如果中断屏蔽位 l0 和 l1 在中断服务函数（ISR）中被使用 SIM 指令置位，使用 RIM 对中断屏蔽进行移除将造成软件优先级被设置为 0 级。



为了在中断服务函数中使能或禁止中断时恢复正确的优先级，遵循 Table 8 中的步骤来使能或禁止中断。



![Image.png](https://i.loli.net/2019/03/03/5c7b55e11a877.png)



#### 一、服务挂起中断



几个中断可以同时被挂起。下一个要处理的中断由以下两步操作决定：

1、最高软件优先级的中断被响应。

2、如果几个中断的软件优先级相同，硬件优先级最高的中断首先响应。



当一个中断请求没有被立即响应的时候，它将被锁存，并在软件优先级和硬件优先级相结合为最高优先级的时候进行处理。



注意：

1、硬件优先级是独一无二的，而软件的不是。这允许只有一个中断的时候能继续先前的过程。

2、在判定过程中，RESET，TLI 和 TRAP 被认为拥有最高软件优先级。



![Image.png](https://i.loli.net/2019/03/03/5c7b55fc57659.png)

#### 二、中断源



STM8中断控制器安排了两种中断源类型。

\- 非可屏蔽中断：RESET，TLI 和 TRAP

\- 可屏蔽中断：外部中断或内部外设触发的中断



**非可屏蔽中断源**



在处理非可屏蔽中断源时，忽略 CCR 寄存器的 l1 和 l0 的状态。PC，X，Y，A 和 CCR 寄存器只有在一个 TRAP 中断发生时入栈。然后，相应的中断向量载入 PC 寄存器，CCR 寄存器的 l1 和 l0 设置为禁止中断。



● TRAP（非可屏蔽软件中断）

​     当 TRAP 指令执行时，这个软件中断源得到响应。它和 TLI 一样根据 Figure 13 的流程图来响应。

​     TRAP 中断不允许处理器从 Halt 模式下退出。



● RESET

​     RESET 中断源拥有 STM8 最高等级的软件和硬件优先级。这意味着在复位程序的开始，所有的中断都会被禁止。它们必须被 RIM 指令重使能。

​     RESET 中断允许处理器从 Halt 模式下退出。



● TLI（顶级硬件中断）

​     这个硬件中断发生在在的 TLI 输入端检测到一个特定的边沿时。

​     TLI 服务函数中必须使用一个 TRAP 指令。

   

**可屏蔽中断源**



如果可屏蔽中断被使能，而且如果它自己在 ITC_SPRx 寄存器中的中断软件优先级比当前正在响应的中断（CCR 寄存器中的 l1 和 l0）高，该可屏蔽中断向量源开始响应。如果这两个条件之一没有满足，中断将被锁存并挂起。



**外部中断**



外部中断可被用来从 Halt 模式下唤醒 CPU。器件对外部中断的边沿敏感性可通过外部中断控制寄存器（EXTI_CRx）进行软件选择。



当连接到同一个中断线的几个输入引脚同时被选择时，他们是逻辑或的关系。



当外部电平触发中断被锁存时，如果给定的电平在中断程序的最后依然保持时，中断保持激活，除非它在程序中被禁止。



**外设中断**



大多数外部中断能将 MCU 从 Halt 模式下唤醒。



当外设状态寄存器中的一个特定的标志位置位，并且外设控制寄存器中相应的使能位置位时，发生一个外设中断。

​     

------

### 中断和低功耗模式



所有中断都能使处理器从 wait 模式中退出。



只有外部中断及其他特殊中断允许处理器从 halt 和 active-halt 模式下退出。



当从 halt 模式下唤醒又同时有几个中断挂起时，第一个响应的中断只能是一个能从 halt 模式退出的中断。它由 Figure14 中给出的过程精确选择。如果最高优先级的挂起中断不能将器件从 halt 模式中唤醒，将会响应下一个中断。



如果 HALT 指令执行时发生了任意内部或外部中断（例如定时器），HALT 指令会被执行完但是在 HALT 指令完成之后中断会立即调用唤醒机制。这样，MCU 实际上是从 halt 模式唤醒到 run 模式，相应的延迟参考 datasheet 中的 tWUH。



---

### 活跃等级/低功耗模式控制



MCU 的活跃等级通过编程 CFG_GCR 寄存器中的 AL 位来配置。



这一位用来控制 MCU 的低功耗模式。在非常低功耗的应用中，MCU 的大部分时间花在 WFI，并且在特殊时刻（通过中断）来唤醒以执行特殊任务。这些再发任务中，有一些非常短，可以直接在中断服务函数（ISR）里执行，而不用回到主函数中。对于这种情况，可以在进入低功耗模式以前（同过执行 WFI 指令）将 AL 置位，然后中断函数直接返回到低功耗模式。由于寄存器上下文只保存在第一个中断中，run time/ISR 指令相应缩减。



因此，在非常简单的应用中，所有操作都可以在 ISR 中执行。在更复杂的应用中，一个中断函数可以通过复位 AL 位来重新启动主函数。



例如，一个应用可能需要每隔 50ms 由自动唤醒单元（AWU）来唤醒，以检查一些引脚/传感器/按键的状态。大部分时间，当这些引脚未激活时，MCU 可以返回到低功耗模式而不运行主函数。如果这些引脚的其中之一激活，ISR 将通过复位 AL 位来启动主函数。



---

### 并发和嵌套中断管理



STM8 器件的特色之一是有两个中断管理模式：

\- 并发模式

\- 嵌套模式



#### 一、并发中断管理模式



在这以模式下，所有中断都是 3 级优先级，所以它们都不能被中断，除了 TLI，RESET 或 TRAP。



硬件优先级按照下面的从低到高的顺序给出：MAIN，IT4，IT3，IT2，IT1，IT0，TRAP/TLI（优先级相同），RESET。



![Image.png](https://i.loli.net/2019/03/03/5c7b56c0dcd3c.png)



二、嵌套中断管理模式：



在这个模式下，可以在中断函数中嵌套中断。只要有一个中断优先级低于 3 级，这个模式就会被激活。



硬件优先级按下面的从低到高的顺序给出：MAIN，IT4，IT3，IT2，IT1，IT0，TRAP。



每一个中断向量都可以通过设置相应的 ITC_SPRx 寄存器的 l1_x 和 l0_x 位，来配置软件优先级。l1_x 和 l0_x 位与 CCR 寄存器的 l1 和 l0 位的意义相同。



不能编程为等级 0（l1_x = 1，l0_x = 0）。在这种情况下，将保持先前存储的值。例如，如果先前的值为 0xcf，编程值等于 64h，结果是 44h。



RESET 和 TRAP 向量没有软件优先级。当其中一个被响应时，CCR 寄存器的 l1 和 l0 位都会置位。



注意：如果中断 x 被执行时，l1_x 和 l0_x 位被修改，器件会进行以下操作：如果中断 x 仍然挂起（新的中断或标志位没有清除）且新的软件优先级比先前的一个高，那么中断 x 将重新进入。否则，中断优先级将保持不变直到下一个中断请求（在中断 x 的 IRET 之后）。



在一个中断函数执行期间，HALT，POPCC，RIM，SIM 和 WFI 指令会改变当前的软件优先级，直到下一个 IRET 指令或前面提到的指令之一被发出。



警告：可能会发生栈溢出，而不通知软件这个错误。



![Image.png](https://i.loli.net/2019/03/03/5c7b56e820fb8.png)

![Image.png](https://i.loli.net/2019/03/03/5c7b56f6c91b9.png)



---

### 外部中断



五个中断向量专用于外部中断事件：

- PA 口有 5 个中断线：PA[6:2]

- PB 口有 8 个中断线：PB[7:0]

- PC 口有 8 个中断线：PC[7:0]

- PD 口有 7 个中断线：PD[6:0]

- PE 口有 8 个中断线：PE[7:0]



除了 20 脚封装的器件可以使用一个备用功能重映射操作位在 PC3 脚上获得 TLI，其他器件的 PD7 是最高级中断源（TLI）。



为了触发一个中断，相应的 GPIO 端口必须配置成有中断功能的输入模式。



中断的边沿敏感性必须由 EXTI_CR1 和 EXTI_CR2 寄存器配置。



---

### 中断指令



![Image.png](https://i.loli.net/2019/03/03/5c7b57479ebfa.png)



![Image.png](https://i.loli.net/2019/03/03/5c7b575da4506.png)



---

### ITC（中断控制）和EXTI（外部中断）寄存器

#### 一、CPU 状态码寄存器中断位（CCR）

![Image.png](https://i.loli.net/2019/03/03/5c7b5840e7b1b.png)



l[1:0]：软件中断优先级位



这两位表示当前中断请求的软件优先级。当一个中断请求发生时，相应中断的软件优先级从软件优先级寄存器（ITC_SPRx）自动载入。



l[1:0] 位也可以使用 RIM，SIM，HALT，WFI，IRET 或 PUSH/POP 指令来软件清空。



![Image.png](https://i.loli.net/2019/03/03/5c7b585894fa4.png)



TLI，TRAP 和 RESET 时间可以中断一个 3 级的程序。



#### 二、软件优先级寄存器 x（ITC_SPRx）



![Image.png](https://i.loli.net/2019/03/03/5c7b587097956.png)



由软件写入，来定义每一个中断向量的软件优先级。



ITC_SPR1 的 [1：0] 位由硬件强制置 1（TLI）

ITC_SPR8 的 [7：4] 位由硬件强制置 1



禁止写入 10（优先级 0），如果写入 10，将保持原来的值，且中断优先级不会改变。



#### 三、外部中断控制寄存器 1（EXTI_CR1）

![Image.png](https://i.loli.net/2019/03/03/5c7b5893277f1.png)



#### 四、外部中断控制寄存器 2（EXTI_CR2）

![Image.png](https://i.loli.net/2019/03/03/5c7b58e6cd03b.png)



#### 五、ITC 和 EXTI 寄存器映射和复位值

![Image.png](https://i.loli.net/2019/03/03/5c7b59026b53a.png)







