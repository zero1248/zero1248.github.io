---
title: STM8S 电源管理
tags:
  - 硬件拾忆
  - STM8
abbrlink: d8daeb2e
date: 2019-03-03 13:59:08
---

---

默认情况下在系统或电源复位后，MCU 处于运行模式。在这种模式下，CPU 由 fCPU 提供时钟并执行程序代码，系统时钟分别为各个处于激活状态的外设提供时钟，MCU 功耗最大。

<!--more-->

在运行模式下，为了保持 CPU 继续运行并执行代码，有以下几种途径可以降低功率消耗：

- 降低系统时钟

- 关闭未使用外设的时钟

- 关闭所有未使用的模拟功能块



但是，如果 CPU 不需要保持运行，可使用下列三种低功耗模式：

- 等待（Wait）

- 活跃停机（Active Halt）可配置为慢速或快速唤醒

- 停机（Halt）可配置为慢速或快速唤醒



用户可选择以上三种模式中的一种，并合理配置，以在最低功耗、最快唤醒速度和可使用的唤醒源之间获得最佳平衡点。



---

### 一、常规考虑



硅片中通常存在两种功耗：

- 静态功耗：由极化电流和漏电流造成。静态功耗很小，只在停机（Halt）模式和活跃停机（Active Halt）模式下有意义。

- 动态功耗：来自于芯片上正在运行的数字模块。它取决于 VDD，时钟频率和负载电容。



一个 MCU 的功耗取决于：

- VDD 供电电压

- 模拟性能

- MCU 大小及数字逻辑门数（漏电流及负载电容）

- 时钟频率

- 处于激活状态的外设数目

- 可用的低功耗模式及级别



MCU 的处理速度也很重要，这使得用户程序只需很短时间处于运行状态，而更多时间处于低功耗模式下。



---

### 二、低功耗的时钟管理



#### 1、降低系统时钟



通过写时钟分频寄存器 CLK_CKDIVR 的位 CPUDIV[2:0]，可降低 fCPU 的时钟频率。这会降低 CPU 的速度，但同时可降低 CPU 的功耗。其它外设（由 fMASTER 提供时钟）不会受此设置影响。



在运行模式下，任何时候需要恢复全速运行，将 CPUDIV[2:0] 清 0 即可。



#### 2、外设时钟门控



使用时钟门控，用户可在任意时间打开或关闭 fMASTER 与各个外设的连接，在运行模式和等待模式均有效。



---

### 三、低功耗模式

![Image.png](https://i.loli.net/2019/03/03/5c7b6f3d4ef26.png)



#### 1、等待模式（Wait）



在运行模式下执行 WFI（等待中断）指令，可进入等待模式。此时 CPU 停止运行，但外设与中断控制器仍保持运行，因此功耗会有所降低。等待模式可与 PCG（外设时钟门控），降低 CPU 时钟频率，以及选择低功耗时钟源（LSI，HSI）相结合使用，以进一步降低系统功耗。



等待模式下，所有寄存器与 RAM 的内容保持不变，之前所定义的时钟配置也保持不变（CLK_CMSR） 。



当一个内部或外部中断请求发生时，CPU 从等待模式唤醒并恢复工作。



#### 2、停机模式（Halt）



该模式下主时钟停止。即由 fMASTER 提供时钟的 CPU 及所有外设均被关闭。因此，所有外设均没有时钟，MCU 的数字部分不消耗能量。



停机模式下，所有寄存器与 RAM 的内容保持不变，默认情况下时钟配置也保持不变（CLK_CMSR）。



MCU 可通过执行 HALT 指令进入停机模式。外部中断可将 MCU 从停机模式唤醒。外部中断指配置为中断输入的 GPIO 端口或具有触发外设中断能力的端口。



这种模式下，仅低电压调节器（和掉电复位）处于工作状态。



**快速时钟启动**



HSI RC 的启动速度比 HSE 快。因此，为了减少 MCU 唤醒时间，建议在进入暂停模式前选择 HSI 作为 fMASTER 的时钟源。在进入停机模式前可通过设置内部时钟寄存器 CLK_ICKR 的 FHWU 位选择 HSI 作为 fMASTER 的时钟源，而无需时钟切换。 



#### 3、活跃停机模式（Active Halt）



活跃停机模式与停机模式类似，但它不需要外部中断唤醒。它使用 AWU，在一定的延时后，产生一个内部唤醒事件，延迟时间是用户可编程的。



在活跃停机模式下，主振荡器，CPU 以及几乎所有外设都被停止。如果 AWU 和 IWD 已被使能，则只有 LSI RC 和 HSE 仍处于运行状态，以驱动 AWU 和 IWD 计数器。



为进入活跃停机模式，需首先使能 AWU然后执行 HALT 指令。



**主电源调节器自动关闭**



默认情况下，为了从活跃停机模式快速唤醒，主电压调节器处于激活状态。但其电流消耗是不可忽视的。



为进一步降低功耗，当 MCU 进入活跃停机模式时，主电压调节器可自动关闭。通过设置内部时钟寄存器 CLK_ICKR 的 REGAH 位可实现此功能。此时:

\- MCU 内核由低功耗电压调节器（LPVR）供电。

\- 仅 LSI 时钟源可用，因为 HSE 时钟源对于 LPVR 来说电流消耗太大。



在唤醒时主电压调节器重新被打开，这需要一个比较长的唤醒时间。



**快速唤醒时钟**



为了缩短唤醒时间，建议使用 HSI 作为 fMASTER 的时钟源。FHWU 位也可用于缩短切换时间。



在活跃停机模式下，快速唤醒时很重要的。这可以提高 CPU 的执行效率，使 MCU 处于运行状态与低功耗模式之间的时间最短，从而减少整体平均功耗。



---

### 四、附加的模拟功耗控制



#### 1、停机模式下的快速内存唤醒



默认情况下，MCU 进入 Halt 模式后 FLASH 是处于掉电状态的。此时，漏电流可忽略，功耗是非常低的。但 FLASH 的唤醒时间较长（几us）。

​    

如果用户需要从 Halt 模式快速唤醒，可将 FLASH_CR1 的 HALT 位置 1。当 MCU 进入停机模式时，这将确保 FLASH 处于等待状态，唤醒时间降至几纳秒。但功耗将增至几 uA。



#### 2、活跃停机模式下的超低内存功耗



在活跃停机模式下，为加快唤醒时间，默认情况下 FLASH 处于工作状态，因此并没有降低功耗。

为降低功耗，用户可将 FLASH_CR1 的 AHALT 位置 1。在进入活跃停机模式时，这将停止向 FLASH 供电以降低功耗，但唤醒时间将增至微秒级。